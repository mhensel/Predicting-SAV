---
title: "Predicting-SAV: 2020-2060 Projections"
author: "Marc Hensel"
date: "2022-11-07"
output: html_document
editor_options: 
  chunk_output_type: console
---
Predicting-SAV Project: Climate Change and Nutrient Management Projections
This markdown represents the  assembly of the FINAL projection code, plus summary figures and statistics, for 100 simulations.
Originally this was supposed to be the "whole" project on one thing but it turned into a mess down at the post-simulation part. Needs to be cleaned up big time

```{r LOAD ME required packages, echo=FALSE}

library(tidyverse); library(lme4); library(car); library(vroom); library(performance); library(lubridate)
library(geomtextpath); library(readxl); library(patchwork)

```


#Future Env Proj Data by Scenario and Community: Begin prediction workflow here
These data frames are for *100 simulations* of predicted environemtal conditions under the "No Further Action" and "Nutrient Management" Scenarios for each of the Zostera, Ruppia, Mixed Mesohaline, and Freshwater communities
Past data (from CBP WQ Stations 1984-2019 minus some NAs) has been detrended, 
Future data (from Lew's group 2020-2060) has been smoothed out to remove decadal jumps
Note: 1000 sims would require changed inputs


```{r Future environmental projections by scenario and by community, Shuffled. This is used to predict! }
Zostera.OneBay_CC_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Zostera.OneBay_CC_Shuff.csv")
Ruppia.OneBay_CC_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Ruppia.OneBay_CC_Shuff.csv")
MixMeso.OneBay_CC_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/MixMeso.OneBay_CC_Shuff.csv") 
Fresh.OneBay_CC_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Fresh.OneBay_CC_Shuff.csv")

##Nutrient Reduction Scenario
#WIP = Watershed Implementation Program
Zostera.OneBay_WIP_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Zostera.OneBay_WIP_Shuff.csv")
Ruppia.OneBay_WIP_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Ruppia.OneBay_WIP_Shuff.csv")
MixMeso.OneBay_WIP_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/MixMeso.OneBay_WIP_Shuff.csv")
Fresh.OneBay_WIP_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Fresh.OneBay_WIP_Shuff.csv")

##Connowingo Reduction Scenario
#NOTE: only to 2040
Zostera.OneBay_CON_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Zostera.OneBay_CON_Shuff.csv")
Ruppia.OneBay_CON_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Ruppia.OneBay_CON_Shuff.csv")
MixMeso.OneBay_CON_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/MixMeso.OneBay_CON_Shuff.csv")
Fresh.OneBay_CON_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Fresh.OneBay_CON_Shuff.csv")

#GROWTH
Zostera.OneBay_GRO_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Zostera.OneBay_GRO_Shuff.csv")
Ruppia.OneBay_GRO_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Ruppia.OneBay_GRO_Shuff.csv")
MixMeso.OneBay_GRO_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/MixMeso.OneBay_GRO_Shuff.csv")
Fresh.OneBay_GRO_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Fresh.OneBay_GRO_Shuff.csv")

#Never Action Scen
Zostera.OneBay_NOACT_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Zostera.OneBay_NOACT_Shuff.csv")
Ruppia.OneBay_NOACT_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Ruppia.OneBay_NOACT_Shuff.csv")
MixMeso.OneBay_NOACT_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/MixMeso.OneBay_NOACT_Shuff.csv")
Fresh.OneBay_NOACT_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Fresh.OneBay_NOACT_Shuff.csv")


```


```{r BaeEnvGrow full env projection by scenario for segments}
#New Scens will need to be added here. This is the growing season data, to compare conditions across communities
#Takes a while
BaeEnvGrow.SEGMENT_2060 = full_join(WIP.wl_growPP %>% rename("year" = "year.x", "Year.ref" = "year.y") %>% 
                                  ungroup() %>%
                              nest_by(year, Year.ref) %>% 
  drop_na() %>% #one set of sims uses 2020 as a reference for 2021 and it comes up as NA
  full_join(OB_od90) %>% #new for ONEBAY
  arrange(simnum_OB) %>% #new for ONEBAY
  unnest(cols = c(data, year, Year.ref, simnum_OB)) %>%  
  select(simnum_OB, year, everything())  %>% 
  ungroup() %>%
  select(-Year.ref) %>% 
  add_column(Scen = "Nutrient Reduction"), 
                            CC.wl_growPP %>% rename("year" = "year.x", "Year.ref" = "year.y") %>% 
    ungroup() %>%
    nest_by(year, Year.ref) %>% 
  drop_na() %>% #one set of sims uses 2020 as a reference for 2021 and it comes up as NA
  full_join(OB_od90) %>% #new for ONEBAY
  arrange(simnum_OB) %>% #new for ONEBAY
  unnest(cols = c(data, year, Year.ref, simnum_OB)) %>%  
  select(simnum_OB, year, everything())  %>% 
  ungroup() %>%
  select(-Year.ref) %>% 
  add_column(Scen = "No Action")) %>% 
  full_join(SegmentConvert) %>% 
  select(year, cbpseg, Station, simnum_OB, Scen, Temp.growme, Sal.growme, Chla.growme, Secc.growme, TN.growme, TP.growme) %>%
  group_by(simnum_OB, Scen, year, cbpseg) %>%
  summarise(across(everything(), mean, na.rm = T, .names = "{col}")) #instead of with SAV where we sum every station inside of the segmemt, we take the mean!
  
vroom_write(BaeEnvGrow.SEGMENT_2060, "/Volumes/savshare2/Current Projects/Predicting-SAV/data/communityDFs/BaeEnvGrow.SEGMENT_2060.csv")

WIP.wl_growPP_shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/WIP_EnvGrowSzn_Shuff.csv")
CC.wl_growPP_shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/CC_EnvGrowSzn_Shuff.csv")

#this takes forever and may be messed up so maybe dont do it 
#BaeEnvGrow.SEGMENT_2060_Shuff = full_join(WIP.wl_growPP_shuff %>% rename("year" = "year.x", "Year.ref" = "year.y") %>% 
                                  ungroup() %>%
                              nest_by(year, Year.ref) %>% 
  drop_na() %>% #one set of sims uses 2020 as a reference for 2021 and it comes up as NA
  full_join(OB_od90) %>% #new for ONEBAY
  arrange(simnum_OB) %>% #new for ONEBAY
  unnest(cols = c(data, year, Year.ref, simnum_OB)) %>%  
  select(simnum_OB, year, everything())  %>% 
  ungroup() %>%
  select(-Year.ref) %>% 
  add_column(Scen = "Nutrient Reduction"), 
                            CC.wl_growPP_shuff %>% rename("year" = "year.x", "Year.ref" = "year.y") %>% 
    ungroup() %>%
    nest_by(year, Year.ref) %>% 
  drop_na() %>% #one set of sims uses 2020 as a reference for 2021 and it comes up as NA
  full_join(OB_od90) %>% #new for ONEBAY
  arrange(simnum_OB) %>% #new for ONEBAY
  unnest(cols = c(data, year, Year.ref, simnum_OB)) %>%  
  select(simnum_OB, year, everything())  %>% 
  ungroup() %>%
  select(-Year.ref) %>% 
  add_column(Scen = "No Action")) %>% 
  full_join(SegmentConvert) %>% 
  select(year, cbpseg, Station, simnum_OB, Scen, Temp.growme, Sal.growme, Chla.growme, Secc.growme, TN.growme, TP.growme) %>%
  group_by(simnum_OB, Scen, year, cbpseg) %>%
  summarise(across(everything(), mean, na.rm = T, .names = "{col}")) #instead of with SAV where we sum every station inside of the segmemt, we take the mean!
  
vroom_write(BaeEnvGrow.SEGMENT_2060_Shuff, "/Volumes/savshare2/Current Projects/Predicting-SAV/data/communityDFs/BaeEnvGrow.SEGMENT_2060_Shuff.csv")

```

```{r  shuff after shuff run on assumbel climate data}
CC.wl_growPP_shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/CC_EnvGrowSzn_shuff.csv")
WIP.wl_growPP_shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/WIP_EnvGrowSzn_shuff.csv")
SegmentConvert = read_excel("/Volumes/savshare2/Current Projects/Predicting-SAV/DW_Predicting-SAV/SAV Comp 71_20 area by station and segment.xlsx", sheet = 2) 
OB_od90 = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/communityDFs/FutureMatrix1990-2020.csv")
#takes a while! 
BaeEnvGrow.SEGMENT_2060_shuff = full_join(
  WIP.wl_growPP_shuff %>% #might need to remake this?
    rename("year" = "year.x", "Year.ref" = "year.y") %>%
    ungroup() %>% 
    nest_by(year, Year.ref) %>% 
    drop_na() %>% #one set of sims uses 2020 as a reference for 2021 and it comes up as NA
    full_join(OB_od90) %>% #new for ONEBAY
    arrange(simnum_OB) %>% #new for ONEBAY
    unnest(cols = c(data, year, Year.ref, simnum_OB)) %>%  
    select(simnum_OB, year, everything())  %>% 
    ungroup() %>%
    select(-Year.ref) %>% 
    add_column(Scen = "Nutrient Reduction"), 
  CC.wl_growPP_shuff %>% rename("year" = "year.x", "Year.ref" = "year.y") %>% 
    ungroup() %>%
    nest_by(year, Year.ref) %>% 
    drop_na() %>% #one set of sims uses 2020 as a reference for 2021 and it comes up as NA
    full_join(OB_od90) %>% #new for ONEBAY
    arrange(simnum_OB) %>% #new for ONEBAY
    unnest(cols = c(data, year, Year.ref, simnum_OB)) %>%  
    select(simnum_OB, year, everything())  %>% 
    ungroup() %>%
    select(-Year.ref) %>% 
    add_column(Scen = "No Action")) %>% #this ends the full_join()
  full_join(SegmentConvert) %>% 
  select(year, cbpseg, Station, simnum_OB, Scen, Temp.growme, Sal.growme, Chla.growme, Secc.growme, TN.growme, TP.growme) %>%
  group_by(simnum_OB, Scen, year, cbpseg) %>%
  summarise(across(everything(), mean, na.rm = T, .names = "{col}")) #instead of with SAV where we sum every station inside of the segmemt, we take the mean!
  
vroom_write(BaeEnvGrow.SEGMENT_2060_shuff, "/Volumes/savshare2/Current Projects/Predicting-SAV/data/communityDFs/BaeEnvGrow.SEGMENT_2060_shuff.csv")
```

```{r looking at some of the future env data}


ggplot(data = Zostera.OneBay_WIP %>% filter(between(simnum_OB, 6, 19)) ) +
  stat_summary(aes(x = year, y = TN.spme, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "lightgreen") +
   # stat_smooth(aes(x = year, y = TN.spme), method = "gam", size = 1, color = "darkgreen") +
    stat_summary(data = Zostera.OneBay_CC, 
                 aes(x = year, y = TN.spme, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "cyan1") +
   # stat_smooth(data = Zostera.OneBay_CC %>% filter(between(simnum_OB, 6, 19)),
    #            aes(x = year, y = TN.spme), method = "gam", size = 1, color = "cyan2") +
      stat_summary(aes(x = year, y = TN.spme), fun.data = "mean_se", geom = "line", size =1, color = "brown") +
        stat_summary(data = Zostera.OneBay_CC %>% filter(between(simnum_OB, 6, 19)), 
                 aes(x = year, y = TN.spme), fun.data = "mean_se", geom = "line", size = 1, color = "red") +
  stat_summary(data = ZoDensWQsem.No0_Predict,
               aes(x = year, y = TN.spme), fun.data = "mean_se", geom = "line", size = .9)

ggplot(data = Zostera.OneBay_WIP %>% filter(between(simnum_OB, 6, 19)) ) +
  stat_summary(aes(x = year, y = Temp.sumy1med, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "lightgreen") +
   # stat_smooth(aes(x = year, y = TN.spme), method = "gam", size = 1, color = "darkgreen") +
    stat_summary(data = Zostera.OneBay_CC, 
                 aes(x = year, y = Temp.sumy1med, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "cyan1") +
   # stat_smooth(data = Zostera.OneBay_CC %>% filter(between(simnum_OB, 6, 19)),
    #            aes(x = year, y = TN.spme), method = "gam", size = 1, color = "cyan2") +
      stat_summary(aes(x = year, y = Temp.sumy1med), fun.data = "mean_se", geom = "line", size =1, color = "brown") +
        stat_summary(data = Zostera.OneBay_CC %>% filter(between(simnum_OB, 6, 19)), 
                 aes(x = year, y = Temp.sumy1med), fun.data = "mean_se", geom = "line", size = 1, color = "red") +
  stat_summary(data = ZoDensWQsem.No0_Predict,
               aes(x = year, y = Temp.sumy1med), fun.data = "mean_se", geom = "line", size = .9)

ggplot(data = Ruppia.OneBay_WIP %>% filter(between(simnum_OB, 1, 3))) +
  stat_summary(aes(x = year, y = TN.spme, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "lightgreen") +
    stat_smooth(aes(x = year, y = TN.spme), method = "gam", size = 1, color = "green") +
    stat_summary(data = Ruppia.OneBay_CC %>% filter(between(simnum_OB, 1, 3)), 
                 aes(x = year, y = TN.spme, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "cyan1") +
    stat_smooth(data = Ruppia.OneBay_CC %>% filter(between(simnum_OB, 1, 3)), aes(x = year, y = TN.spme), method = "gam", size = 1, color = "cyan2") +
      stat_summary(aes(x = year, y = TN.spme), fun.data = "mean_se", geom = "line", size =1, color = "brown") +
        stat_summary(data = Ruppia.OneBay_CC, 
                 aes(x = year, y = TN.spme), fun.data = "mean_se", geom = "line", size = 1, color = "red") +
  stat_summary(data = RuDensWQsem.No0_Predict,
               aes(x = year, y = TN.spme), fun.data = "mean_se", geom = "line", size = .9) #+

```

#Run all Initial Community Dataframes and ME models
Very crucial chunk to run. This creates the following for each community: 
XXX_station = list of stations that feeds into loop
XXXDensWQsem.No0_Predict = Community filtered, past data with just the variables needed
TWO Models: XXXInt.lmer = modelling change in density percomposite area 
            XXXDWM.lmer = modelling annual density weighted area (not change!)
It would be fine to chunk this up by community but just creates more clicks
#Load initial community DF and models
```{r ALWAYS RUN THIS! Past Data and Initial Community Dataframes and ME models}
####Load these DFs needed for ALL loops but not in loop####
##SAV Density and WQ per Community over past time#

#SAVCommDensWQ_ForPred = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/communityDFs/SAVCommDensWQ_ForPredictions.csv") #past water quality and sav data 1984-2020. Basically no NAs, just in 1984 and in Temp.summax
#filter either of these to 00-20 if we want to do that.
#SAVCommDensWQ_ForPred = vroom("data/SAVCommDensWQ_forPredictions.csv") #github paths

#main past data DF here. 4968 points. 84-2020. I may have median replaced the NAs in environemtnal data
SAVCommDensWQ_ForPred.with0s = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/communityDFs/SAVCommDensWQ_ForPredictions.with0s.csv")
#What is this? It is the SAV, SP Cluster, and ENV data by station by sp cluster. .with0s has all of the 0s and is 725 more points. We also median replaced all of the NAs in this whole dataset. nearly all of the replacements were from the 84-90 time chunk. We have not officially replaced spring 2020 although some NAs were indeed put in that slot. We did a pre and post Y2K median replacement, because there were some more modern NAs but not that many at all.
#Does this have NO missing years and NO NAs? the .with0s should be that... 

#View(SAVCommDensWQ_ForPred %>% group_by(year) %>% 
#       summarise(across(everything(), ~ sum(is.na(.)))))

SegmentGoals = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/State Chesapeake SAV Segment Goals (Acres).csv", col_types = c(StateGoal = "d"))

#PAXMH3, 6, POCOH have NA as goals. PAXMH3 is the only one that comes up in the analyses and its a really really small area. I'm adding a goal of 1. 
#PMKOH and WBRTF have goals of 0 but have grass bc of Ruppia. I'm adding a goal of 1 as well.

SegGoals = SegmentGoals %>% 
  group_by(CBPSEG) %>% #summarize over states
  summarize(Goal = sum(StateGoal)) %>% rename(cbpseg = CBPSEG) %>%
  mutate(Goal = case_when(Goal == 0 ~ 1, 
                          TRUE ~ Goal)) %>% 
  mutate(Goal = replace_na(Goal, 0.5))
#convert Stations to Segments (past data..this is repeated later with the future data too!) This doesnt get used in the projections but im building it here anyways

SegmentConvert = read_excel("/Volumes/savshare2/Current Projects/Predicting-SAV/DW_Predicting-SAV/SAV Comp 71_20 area by station and segment.xlsx", sheet = 2) 


#SAVCommDensWQ_ForPred.SEG = right_join(SAVCommDensWQ_ForPred.with0s, SegmentConvert %>% rename(STATION = Station)) %>% #bring the basins in
  #filter(SpCluster %in% c("Ruppia", "Zostera", "Fresh", "MixedMeso")) %>% #filter out the RuZo and other comms
#  group_by(year, cbpseg, SpCluster) %>%
#  mutate(Area.seg = sum(SAVArea * Pct_stn_area/100), 
#         DWM.seg = sum(dens.weight.mean * Pct_stn_area/100)) %>% 
#  summarise(across(Temp.sumy1med:TN.summe, mean, na.rm = T, .names = "{col}"), 
#            Area.seg = Area.seg, 
#            DWM.seg = DWM.seg) %>% 
 # select(year, cbpseg, SpCluster, Area.seg, DWM.seg, everything()) 

SAVCommDensWQ_ForPred.SEG = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/communityDFs/SAVCommDensWQ_ForPred.SEG.csv")
#Calculate all past ENV Grow BaeEnvGrow.SEGMENT_8420####
#BaeEnvGrow.SEGMENT_8420 = full_join(CBPallclean_grow84, SegmentConvert) %>% #bring the basins in
 # select(year, cbpseg, Temp.growme, Sal.growme, Chla.growme, Secc.growme, TN.growme, TP.growme) %>%
 # group_by(year, cbpseg) %>%
 # summarise(across(Temp.growme:TP.growme, mean, na.rm = T, .names = "{col}")) 

#vroom_write(BaeEnvGrow.SEGMENT_8420, "/Volumes/savshare2/Current Projects/Predicting-SAV/data/communityDFs/BaeEnvGrow.SEGMENT_8420.csv")

#SAVCommDensWQ_ForPred.SEG = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/communityDFs/SAVCommDensWQ_ForPred.SEG.csv")

#Build basins data. Altho...lets hold off on this for now.####
#seg_info = readxl::read_excel("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Stations_byBasinGroup.xlsx", col_names = T, skip = 1)

#vector of all the future years, need this in the projection loop####
future_yrs = seq(2020, 2060, by = 1) #should this be 2021
future_yrsCON = seq(2020, 2040, by = 1)


#Zostera Initial and Model####
#DF and model for Zostera
ZoDensWQsem.No0_Predict = SAVCommDensWQ_ForPred.with0s %>% #allclean is the 2000-2020 data! 
  filter(SpCluster == "Zostera") %>%
#  filter(!STATION %in% c("LE5.5-W")) %>% #seriously fuck this station.
  filter(!denscomp.max < 1) %>%
  ungroup() %>% 
  select(STATION, year, dens.percomp.y1, dens.percomp.change, dens.weight.mean, dens.weight.mean.y1,
         denscomp.max, dens.percomp, 
         Chla.spme, TN.spme, Secc.summe, Temp.sumy1med, Sal.summed, Temp.spmed, Temp.spme) %>%
  mutate(dens.weight.mean = case_when(dens.weight.mean == 0 ~ 0.0001, 
                                      TRUE ~ dens.weight.mean)) %>%
  mutate(dens.weight.mean.y1 = case_when(dens.weight.mean.y1 <= 0 ~ 0.0001, 
                                         TRUE ~ dens.weight.mean.y1)) %>%
  as.data.frame()

#vector of zos_stations for the loop
zos_station = unique(ZoDensWQsem.No0_Predict$STATION)

ZoInt.lmer <- lmer(dens.percomp.change ~ dens.percomp.y1  + 
                     log10(Temp.sumy1med) + log10(Sal.summed) + log10(Chla.spme) + log10(Secc.summe) + 
                     (dens.percomp.y1:log10(Temp.spmed)) +  
                     (dens.percomp.y1:log10(Sal.summed)) + (dens.percomp.y1:log10(Chla.spme))+ (dens.percomp.y1:log10(Secc.summe)) + (1|STATION), data = ZoDensWQsem.No0_Predict)
model_performance(ZoInt.lmer)

#check_collinearity(ZoInt.lmer)

ZoDWM.lmer <- lmer(log10(dens.weight.mean) ~ log10(dens.weight.mean.y1)  + 
                     log10(Temp.sumy1med) + log10(Sal.summed) + log10(Chla.spme) + log10(Secc.summe) + 
                     (log10(dens.weight.mean.y1):log10(Temp.spmed)) +  
                     (log10(dens.weight.mean.y1):log10(Sal.summed)) + (log10(dens.weight.mean.y1):log10(Chla.spme))+ (log10(dens.weight.mean.y1):log10(Secc.summe)) + (1|STATION), data = ZoDensWQsem.No0_Predict)

#model_performance(ZoDWM.lmer) #DINGDINGDING
#check_model(ZoDWM.lmer)
#AIC(ZoInt.lmer, ZoDWM.lmer)
#zo_anov = Anova(ZoDWM.lmer, test.statistic = "F")

#Ruppia Initial and Model####
#load in Ru model and dataa
RuDensWQsem.No0_Predict = SAVCommDensWQ_ForPred.with0s %>% #allclean is the 2000-2020 data! 
  filter(SpCluster == "Ruppia") %>%
  filter(!denscomp.max < 1) %>%
  ungroup() %>% 
  select(STATION, year, dens.percomp.y1, dens.percomp.change, dens.weight.mean, dens.weight.mean.y1, denscomp.max, dens.percomp, 
         Temp.spme, Chla.spme, Sal.spme, TP.spme, TN.spme) %>%
  drop_na() %>% #1214 points
  mutate(dens.weight.mean = case_when(dens.weight.mean <= 0 ~ 0.0001, 
                                      TRUE ~ dens.weight.mean)) %>%
  mutate(dens.weight.mean.y1 = case_when(dens.weight.mean.y1 <= 0 ~ 0.0001, 
                                         TRUE ~ dens.weight.mean.y1)) %>%
  as.data.frame()

ru_station = unique(RuDensWQsem.No0_Predict$STATION)

RuInt.lmer <- lmer(dens.percomp.change ~ dens.percomp.y1 + log10(Chla.spme) + 
                     log10(TP.spme) + log10(TN.spme) + log10(Temp.spme) +
                     (dens.percomp.y1:log10(Sal.spme)) + (dens.percomp.y1:log10(Chla.spme)) + 
                     (log10(TP.spme):dens.percomp.y1) + (log10(TN.spme):dens.percomp.y1) + 
                     (log10(Temp.spme):dens.percomp.y1) + (1|STATION), 
                   data = RuDensWQsem.No0_Predict)
#model_performance(RuInt.lmer)

RuDWM.lmer <- lmer(log10(dens.weight.mean) ~ log10(dens.weight.mean.y1) + log10(Chla.spme) + 
                     log10(TP.spme) + log10(TN.spme) + log10(Temp.spme) +
                     (log10(dens.weight.mean.y1):log10(Sal.spme)) + (log10(dens.weight.mean.y1):log10(Chla.spme)) + 
                     (log10(TP.spme):log10(dens.weight.mean.y1)) + (log10(TN.spme):log10(dens.weight.mean.y1)) + 
                     (log10(Temp.spme):log10(dens.weight.mean.y1)) + (1|STATION), 
                   data = RuDensWQsem.No0_Predict)
#model_performance(RuDWM.lmer)

#ru_anov = Anova(RuDWM.lmer, test.statistic = "F")

#MixedMeso Initial and Model####
MMDensWQsem.No0_Predict = SAVCommDensWQ_ForPred.with0s %>% #allclean is the 2000-2020 data! 
  filter(SpCluster == "MixedMeso") %>%
  ungroup() %>% 
  select(STATION, year, dens.percomp.y1, dens.percomp.change, dens.weight.mean, dens.weight.mean.y1, denscomp.max, dens.percomp, 
         Chla.summe, Temp.summe, Temp.summin, TP.summe, TN.summe, Sal.sumy1max) %>%
  drop_na() %>% #161
  mutate(dens.weight.mean = case_when(dens.weight.mean <= 0 ~ 0.0001, 
                                      TRUE ~ dens.weight.mean)) %>%
  mutate(dens.weight.mean.y1 = case_when(dens.weight.mean.y1 <= 0 ~ 0.0001, 
                                         TRUE ~ dens.weight.mean.y1)) %>%
  as.data.frame()

MM_station = unique(MMDensWQsem.No0_Predict$STATION)

MMInt.lmer <- lmer(dens.percomp.change ~ dens.percomp.y1 + log10(TN.summe) + log10(Chla.summe) + log10(TP.summe) +log10(Temp.summin) +log10(Sal.sumy1max):dens.percomp.y1 + log10(Chla.summe):dens.percomp.y1 + log10(TP.summe):dens.percomp.y1 +log10(TN.summe):dens.percomp.y1+ log10(Temp.summin):dens.percomp.y1 + (1|STATION), data = MMDensWQsem.No0_Predict)

#model_performance(MMInt.lmer)

MMDWM.lmer <- lmer(log10(dens.weight.mean) ~ log10(dens.weight.mean.y1) + log10(TN.summe) + log10(Chla.summe) + log10(TP.summe) +log10(Temp.summin) +log10(Sal.sumy1max):log10(dens.weight.mean.y1) + log10(Chla.summe):log10(dens.weight.mean.y1) + log10(TP.summe):log10(dens.weight.mean.y1) +log10(TN.summe):log10(dens.weight.mean.y1)+ log10(Temp.summin):log10(dens.weight.mean.y1) + (1|STATION), data = MMDensWQsem.No0_Predict)

model_performance(MMDWM.lmer)

mm_anov = Anova(MMDWM.lmer, test.statistic = "F")
#Fresh Initial and Model####
FreshDensWQsem.No0_Predict = SAVCommDensWQ_ForPred.with0s %>% 
  filter(SpCluster == "Fresh") %>%
  ungroup() %>% 
  filter(!STATION == "PIS0033") %>% #apparently this PIS station aint in the Projecteddata
  select(STATION, year, dens.percomp.y1, dens.percomp.change, dens.weight.mean, dens.weight.mean.y1, denscomp.max, dens.percomp, 
         Chla.summe, Temp.summe, Temp.summax, Temp.sumy1me, TP.summe, TN.summe, Sal.summe) %>%
  drop_na() %>% #161
  mutate(Sal.summe = Sal.summe + .1) %>%
  mutate(dens.weight.mean = case_when(dens.weight.mean <= 0 ~ 0.0001, 
                                      TRUE ~ dens.weight.mean)) %>%
  mutate(dens.weight.mean.y1 = case_when(dens.weight.mean.y1 <= 0 ~ 0.0001, 
                                         TRUE ~ dens.weight.mean.y1)) %>%
  as.data.frame()

F_station = unique(FreshDensWQsem.No0_Predict$STATION)

FInt.lmer <- lmer(dens.percomp.change ~ dens.percomp.y1 + #CHECK FINT MODEL####
                    log10(Sal.summe) + log10(Chla.summe) + 
                    log10(TP.summe)  + 
                    log10(Temp.sumy1me) + log10(Temp.summe)  + 
                    log10(Sal.summe):dens.percomp.y1 + log10(Chla.summe):dens.percomp.y1 + 
                    #log10(TP.summe):dens.percomp.y1  + #these ones make it singular so idk
                    log10(Temp.sumy1me):dens.percomp.y1 + 
                    (1|STATION), data = FreshDensWQsem.No0_Predict) 

#model_performance(FInt.lmer) #R2 kinda sucks?

FDWM.lmer <- lmer(log10(dens.weight.mean) ~ log10(dens.weight.mean.y1) + #CHECK FINT MODEL####
                  log10(Sal.summe) + log10(Chla.summe) + 
                    log10(TP.summe)  + 
                    log10(Temp.sumy1me) + log10(Temp.summe)  + 
                    log10(Sal.summe):log10(dens.weight.mean.y1) + log10(Chla.summe):log10(dens.weight.mean.y1) + 
                    log10(TP.summe):log10(dens.weight.mean.y1)  + 
                    log10(Temp.sumy1me):log10(dens.weight.mean.y1) + 
                    (1|STATION), data = FreshDensWQsem.No0_Predict) 

#model_performance(FDWM.lmer)
#r2(FDWM.lmer)

#f_anov = Anova(FDWM.lmer, test.statistic = "F")
```


```{r ANOVA tables for models that do predicting}
zo_anov = Anova(ZoDWM.lmer, test.statistic = "F")
ru_anov = Anova(RuDWM.lmer, test.statistic = "F")
mm_anov = Anova(MMDWM.lmer, test.statistic = "F")
f_anov = Anova(FDWM.lmer, test.statistic = "F")
View(zo_anov)
r2(ZoDWM.lmer)
View(ru_anov)
r2(RuDWM.lmer)
View(mm_anov)
r2(MMDWM.lmer)
View(f_anov)
r2(FDWM.lmer)

```


```{r Future is Past Scenario, (if run will randomly reselect data)}
FutEesPast = tibble(year.fut = rep(future_yrs, 100 )) %>% filter(!year.fut == 2020) %>%
  arrange(year.fut) %>% mutate(simnum_OB = rep(1:100, times = 40) ) %>%
  rowwise() %>%
  mutate(SAVCommDensWQ_ForPred.with0s %>% 
           select(year, SpCluster, STATION, denscomp.max:TN.summe, -SAVArea) %>% 
    nest(data = SpCluster:TN.summe) %>% 
    slice_sample(n = 1, replace = T)) %>%
  unnest(cols = c(data)) 

#replace 
twenty20 = SAVCommDensWQ_ForPred.with0s %>% 
  filter(year == 2020) %>% 
  rename(year.fut = year) %>% 
  slice(rep(1:n(), each = 100)) %>%
  group_by(STATION, SpCluster) %>%
  mutate(simnum_OB = rep(1:100, times = 1) )

FutureIsPast.df = FutEesPast %>% 
  bind_rows(twenty20) %>%
  select(-year) %>% 
  rename(year = year.fut) %>%  
  mutate(dens.percomp = case_when(dens.percomp <= 0 ~ 0.0001, 
                                        dens.percomp > 1 ~ 1.0001,
                                        TRUE ~ dens.percomp)) %>%
        mutate(dens.weight.mean = case_when(dens.weight.mean <= 0 ~ 0.0001,
                                            dens.weight.mean > denscomp.max ~ denscomp.max, 
                                            TRUE ~ dens.weight.mean))

vroom_write(FutureIsPast.df, "/Volumes/savshare2/Current Projects/Predicting-SAV/data/communityDFs/FutureIsPast.csv")
```


```{r Visualize Future is Past}
Ru_FutIsPast = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Ru_FutureIsPast.csv")

ggplot(data = Ru_FutIsPast %>% filter(between(simnum_OB, 1, 20)))+ 
  stat_summary(aes(x = year, y = TN.spme, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "red") +
    stat_summary(data = Ru_CC.P1TB100 %>% filter(between(simnum_OB, 1, 20)), aes(x = year, y = TN.spme, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "yellow") +
    stat_summary(data = Ru_WIP.P1TB100 %>% filter(between(simnum_OB, 1, 20)), aes(x = year, y = TN.spme, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "darkgreen") +
    stat_smooth(aes(x = year, y = TN.spme), method = "lm", size = 1, color = "blue") +
    stat_smooth(data = Ru_CC.P1TB100 %>% filter(between(simnum_OB, 1, 20)), aes(x = year, y = TN.spme), method = "lm", size = 1, color = "blue") +
    stat_smooth(data = Ru_WIP.P1TB100 %>% filter(between(simnum_OB, 1, 20)), aes(x = year, y = TN.spme), method = "lm", size = 1, color = "blue") +
  stat_summary(data = RuDensWQsem.No0_Predict,
               aes(x = year, y = TN.spme), fun.data = "mean_se", geom = "line", size = .9)  + 
  labs(y = "Ruppia zone TN", x = "") +
  theme_bw(base_size=32) + 
  scale_x_continuous(breaks=seq(1980, 2070, 10)) +
 # scale_color_manual(values = scencol) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")

ggplot(data = Ru_FutIsPast %>% filter(between(simnum_OB, 1, 20)))+ 
  stat_summary(aes(x = year, y = Temp.spme, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "red") +
    stat_summary(data = Ru_CC.P1TB100 %>% filter(between(simnum_OB, 1, 20)), aes(x = year, y = Temp.spme, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "yellow") +
    stat_summary(data = Ru_WIP.P1TB100 %>% filter(between(simnum_OB, 1, 20)), aes(x = year, y = Temp.spme, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "darkgreen") +
    stat_smooth(aes(x = year, y = Temp.spme), method = "lm", size = 1, color = "blue") +
    stat_smooth(data = Ru_CC.P1TB100 %>% filter(between(simnum_OB, 1, 20)), aes(x = year, y = Temp.spme), method = "lm", size = 1, color = "blue") +
    stat_smooth(data = Ru_WIP.P1TB100 %>% filter(between(simnum_OB, 1, 20)), aes(x = year, y = Temp.spme), method = "lm", size = 1, color = "blue") +
  stat_summary(data = RuDensWQsem.No0_Predict,
               aes(x = year, y = Temp.spme), fun.data = "mean_se", geom = "line", size = .9)  + 
  labs(y = "Ruppia zone Temp", x = "") +
  theme_bw(base_size=32) + 
  scale_x_continuous(breaks=seq(1980, 2070, 10)) +
 # scale_color_manual(values = scencol) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")


```



#Predict the Future!!!####
Final prediction method is to include density percomp change predictions and DWM predictions together
These pasted ones as of Nov 7 2022 come from climate projections_redux
No adaptive necessary
#NOTE: After all the shuffling nonsense, I wrote the real projections we use into a file that says 20 not 100
#Zostera Community, No Action Scenario
100 simulation chunk will take some time!
#Zostera

```{r Zostera Future is Past}

Zostera.FutIsPast = FutureIsPast.df %>% filter(SpCluster == "Zostera") %>%
  select(simnum_OB, year, STATION, Chla.spme, TN.spme, Secc.summe, Temp.sumy1med, Sal.summed, Temp.spmed, Temp.spme, dens.percomp, denscomp.max, dens.weight.mean) %>%
  arrange(simnum_OB, STATION, year) 

bigZodatalist = list()

for (t in 1:100){ 
  #t = 2
  Zos.OTB_CC = Zostera.FutIsPast[Zostera.FutIsPast$simnum_OB == t,] 
  
  Zodatalist = list()
  
  for(s in 1:length(zos_station)) { #length(zos_station)  , but some stations have NA problems so just 11 for now
    # s = 3
    #subset data by site
    siteenvdata <- Zos.OTB_CC[Zos.OTB_CC$STATION == zos_station[s],] 
    # intdendata <- ZDT2019[ZDT2019$STATION == zos_station[s],]
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrs)) { #HERE is basically why i needed the for loop, to start on 2:
      #  y = 2
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],11] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 11 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],13]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(ZoInt.lmer, newdata = .)) %>%
        mutate(dens.weight.mean = 10^(predict(ZoDWM.lmer, newdata = .))) %>%
        mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
        mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                        dens.percomp > 1 ~ 1.0001,
                                        TRUE ~ dens.percomp)) %>%
        mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                            dens.weight.mean > denscomp.max ~ denscomp.max, 
                                            TRUE ~ dens.weight.mean)) %>%
        mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
        mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                               TRUE ~ dens.weight.mean))
      
      
      #col 11 in CYP = dens.percomp | col 11 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,11] <- CurrentYrPredict[1,11] #dens.percomp
      siteenvdata[y,13] <- CurrentYrPredict[1,13] ##dens.weight.mean
      siteenvdata[y,14] <- CurrentYrPredict[1,14] #dens.percomp.change
      siteenvdata[y,15] <- CurrentYrPredict[1,15] #dens.percomp.changeDPC
      
    }
    
    Zodatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(Zodatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigZodatalist[[t]] <- siteenvdataagg
  
}

Zo_FutIsPast = bigZodatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(Zo_FutIsPast,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Zo_FutureIsPast.csv")

#biglist, not needed anymore.
gc(bigZodatalist)


```

#Zostera Community, No Further Action Scenario
```{r Zostera CC_Shuff}

bigZodatalist = list()

for (t in 1:10){ 
  #t = 2
  Zos.OTB_CC = Zostera.OneBay_CC_Shuff[Zostera.OneBay_CC_Shuff$simnum_OB == t,] 
  
  Zodatalist = list()
  
  for(s in 1:length(zos_station)) { #length(zos_station)  , but some stations have NA problems so just 11 for now
    # s = 3
    #subset data by site
    siteenvdata <- Zos.OTB_CC[Zos.OTB_CC$STATION == zos_station[s],] 
    # intdendata <- ZDT2019[ZDT2019$STATION == zos_station[s],]
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrs)) { #HERE is basically why i needed the for loop, to start on 2:
      #  y = 2
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],11] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 11 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],13]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(ZoInt.lmer, newdata = .)) %>%
        mutate(dens.weight.mean = 10^(predict(ZoDWM.lmer, newdata = .))) %>%
        mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
        mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                        dens.percomp > 1 ~ 1.0001,
                                        TRUE ~ dens.percomp)) %>%
        mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                            dens.weight.mean > denscomp.max ~ denscomp.max, 
                                            TRUE ~ dens.weight.mean)) %>%
        mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
        mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                               TRUE ~ dens.weight.mean))
      
      
      #col 11 in CYP = dens.percomp | col 11 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,11] <- CurrentYrPredict[1,11] #dens.percomp
      siteenvdata[y,13] <- CurrentYrPredict[1,13] ##dens.weight.mean
      siteenvdata[y,14] <- CurrentYrPredict[1,14] #dens.percomp.change
      siteenvdata[y,15] <- CurrentYrPredict[1,15] #dens.percomp.changeDPC
      
    }
    
    Zodatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(Zodatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigZodatalist[[t]] <- siteenvdataagg
  
}

Zo_CC.P1TB100_Shuff = bigZodatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(Zo_CC.P1TB100_Shuff,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Zo_CC.PredOneTrueBae.DWM100_Shuff.csv") 


#biglist, not needed anymore.
gc(bigZodatalist)


```

#Zostera Community, Nutrient Reduction Scenario

```{r Zostera WIP_Shuff}
bigZodatalist = list()
for (t in 1:100){ 
  #t = 2
  Zos.OTB_WIP = Zostera.OneBay_WIP_Shuff[Zostera.OneBay_WIP_Shuff$simnum_OB == t,] 
  
  Zodatalist = list()
  
  for(s in 1:length(zos_station)) { #length(zos_station)  , but some stations have NA problems so just 11 for now
    # s = 3
    #subset data by site
    siteenvdata <- Zos.OTB_WIP[Zos.OTB_WIP$STATION == zos_station[s],] 
    # intdendata <- ZDT2019[ZDT2019$STATION == zos_station[s],]
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrs)) { #HERE is basically why i needed the for loop, to start on 2:
      #  y = 2
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],11] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 11 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],13]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(ZoInt.lmer, newdata = .)) %>%
        mutate(dens.weight.mean = 10^(predict(ZoDWM.lmer, newdata = .))) %>%
        mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
        mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                        dens.percomp > 1 ~ 1.0001,
                                        TRUE ~ dens.percomp)) %>%
        mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                            dens.weight.mean > denscomp.max ~ denscomp.max, 
                                            TRUE ~ dens.weight.mean)) %>%
        mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
        mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                               TRUE ~ dens.weight.mean))
      
      
      #col 11 in CYP = dens.percomp | col 11 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,11] <- CurrentYrPredict[1,11] #dens.percomp
      siteenvdata[y,13] <- CurrentYrPredict[1,13] ##dens.weight.mean
      siteenvdata[y,14] <- CurrentYrPredict[1,14] #dens.percomp.change
      siteenvdata[y,15] <- CurrentYrPredict[1,15] #dens.percomp.changeDPC
      
    }
    
    Zodatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(Zodatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigZodatalist[[t]] <- siteenvdataagg
  
}

Zo_WIP.P1TB100_Shuff = bigZodatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(Zo_WIP.P1TB100_Shuff,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Zo_WIP.PredOneTrueBae.DWM100_Shuff.csv")

gc(bigZodatalist)

```

#Zostera Connowingo 
```{r Zostera CON_Shuff}
bigZodatalist = list()
for (t in 1:100){ 
  #t = 2
  Zos.OTB_CON = Zostera.OneBay_CON_Shuff[Zostera.OneBay_CON_Shuff$simnum_OB == t,] 
  
  Zodatalist = list()
  
  for(s in 1:length(zos_station)) { #length(zos_station)  , but some stations have NA problems so just 11 for now
    # s = 3
    #subset data by site
    siteenvdata <- Zos.OTB_CON[Zos.OTB_CON$STATION == zos_station[s],] 
    # intdendata <- ZDT2019[ZDT2019$STATION == zos_station[s],]
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrsCON)) { #HERE is basically why i needed the for loop, to start on 2:
      #  y = 2
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],11] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 11 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],13]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(ZoInt.lmer, newdata = .)) %>%
        mutate(dens.weight.mean = 10^(predict(ZoDWM.lmer, newdata = .))) %>%
        mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
        mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                        dens.percomp > 1 ~ 1.0001,
                                        TRUE ~ dens.percomp)) %>%
        mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                            dens.weight.mean > denscomp.max ~ denscomp.max, 
                                            TRUE ~ dens.weight.mean)) %>%
        mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
        mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                               TRUE ~ dens.weight.mean))
      
      
      #col 11 in CYP = dens.percomp | col 11 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,11] <- CurrentYrPredict[1,11] #dens.percomp
      siteenvdata[y,13] <- CurrentYrPredict[1,13] ##dens.weight.mean
      siteenvdata[y,14] <- CurrentYrPredict[1,14] #dens.percomp.change
      siteenvdata[y,15] <- CurrentYrPredict[1,15] #dens.percomp.changeDPC
      
    }
    
    Zodatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(Zodatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigZodatalist[[t]] <- siteenvdataagg
  
}

Zo_CON.P1TB100_Shuff = bigZodatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(Zo_CON.P1TB100_Shuff,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Zo_CON.PredOneTrueBae.DWM100_Shuff.csv")

gc(bigZodatalist)

```

#Zostera Community, Growth Scenario
```{r Zostera GRO_Shuff}

bigZodatalist = list()

for (t in 1:100){ 
  #t = 2
  Zos.OTB_GRO = Zostera.OneBay_GRO_Shuff[Zostera.OneBay_GRO_Shuff$simnum_OB == t,] 
  
  Zodatalist = list()
  
  for(s in 1:length(zos_station)) { #length(zos_station)  , but some stations have NA problems so just 11 for now
    # s = 3
    #subset data by site
    siteenvdata <- Zos.OTB_GRO[Zos.OTB_GRO$STATION == zos_station[s],] 
    # intdendata <- ZDT2019[ZDT2019$STATION == zos_station[s],]
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrs)) { #HERE is basically why i needed the for loop, to start on 2:
      #  y = 2
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],11] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 11 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],13]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(ZoInt.lmer, newdata = .)) %>%
        mutate(dens.weight.mean = 10^(predict(ZoDWM.lmer, newdata = .))) %>%
        mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
        mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                        dens.percomp > 1 ~ 1.0001,
                                        TRUE ~ dens.percomp)) %>%
        mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                            dens.weight.mean > denscomp.max ~ denscomp.max, 
                                            TRUE ~ dens.weight.mean)) %>%
        mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
        mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                               TRUE ~ dens.weight.mean))
      
      
      #col 11 in CYP = dens.percomp | col 11 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,11] <- CurrentYrPredict[1,11] #dens.percomp
      siteenvdata[y,13] <- CurrentYrPredict[1,13] ##dens.weight.mean
      siteenvdata[y,14] <- CurrentYrPredict[1,14] #dens.percomp.change
      siteenvdata[y,15] <- CurrentYrPredict[1,15] #dens.percomp.changeDPC
      
    }
    
    Zodatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(Zodatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigZodatalist[[t]] <- siteenvdataagg
  
}

Zo_GRO.P1TB100_Shuff = bigZodatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(Zo_GRO.P1TB100_Shuff,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Zo_GRO.PredOneTrueBae.DWM100_Shuff.csv") 


#biglist, not needed anymore.
gc(bigZodatalist)


```

#Zostera Community, Never Action Scenario

```{r Zostera NOACT_Shuff}
bigZodatalist = list()
for (t in 1:100){ 
  #t = 2
  Zos.OTB_NOACT = Zostera.OneBay_NOACT_Shuff[Zostera.OneBay_NOACT_Shuff$simnum_OB == t,] 
  
  Zodatalist = list()
  
  for(s in 1:length(zos_station)) { #length(zos_station)  , but some stations have NA problems so just 11 for now
    # s = 3
    #subset data by site
    siteenvdata <- Zos.OTB_NOACT[Zos.OTB_NOACT$STATION == zos_station[s],] 
    # intdendata <- ZDT2019[ZDT2019$STATION == zos_station[s],]
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrs)) { #HERE is basically why i needed the for loop, to start on 2:
      #  y = 2
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],11] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 11 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],13]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(ZoInt.lmer, newdata = .)) %>%
        mutate(dens.weight.mean = 10^(predict(ZoDWM.lmer, newdata = .))) %>%
        mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
        mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                        dens.percomp > 1 ~ 1.0001,
                                        TRUE ~ dens.percomp)) %>%
        mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                            dens.weight.mean > denscomp.max ~ denscomp.max, 
                                            TRUE ~ dens.weight.mean)) %>%
        mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
        mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                               TRUE ~ dens.weight.mean))
      
      
      #col 11 in CYP = dens.percomp | col 11 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,11] <- CurrentYrPredict[1,11] #dens.percomp
      siteenvdata[y,13] <- CurrentYrPredict[1,13] ##dens.weight.mean
      siteenvdata[y,14] <- CurrentYrPredict[1,14] #dens.percomp.change
      siteenvdata[y,15] <- CurrentYrPredict[1,15] #dens.percomp.changeDPC
      
    }
    
    Zodatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(Zodatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigZodatalist[[t]] <- siteenvdataagg
  
}

Zo_NOACT.P1TB100_Shuff = bigZodatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(Zo_NOACT.P1TB100_Shuff,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Zo_NOACT.PredOneTrueBae.DWM100_Shuff.csv")

gc(bigZodatalist)

```


#Ruppia Community, No Action Scenario
100 simulation chunk will take some time!

```{r Ruppia Future Is Past}
FutureIsPast.df = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/communityDFs/FutureIsPast.csv")
#Get Future is Past setup exactly like Ruppia.OneBay_WIP
Ruppia.FutIsPast = FutureIsPast.df %>% filter(SpCluster == "Ruppia") %>%
  select(simnum_OB, year, STATION, Chla.spme, TP.spme, TN.spme, Sal.spme, Temp.spme, dens.percomp, denscomp.max, dens.weight.mean) %>%
  arrange(simnum_OB, STATION, year) 

bigRudatalist = list()

for (t in 1:100){ 
  #t = 2
  Ru.OTB_WIP = Ruppia.FutIsPast[Ruppia.FutIsPast$simnum_OB == t,] 
  
  Rudatalist = list()
  
  for(s in 1:length(ru_station)) { #length(zos_station)  , but some stations have NA problems so just 11 for now
    # s = 3
    #subset data by site
    siteenvdata <- Ru.OTB_WIP[Ru.OTB_WIP$STATION == ru_station[s],] 
    # intdendata <- ZDT2019[ZDT2019$STATION == zos_station[s],]
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrs)) { #HERE is basically why i needed the for loop, to start on 2:
      #y = 2
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],9] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 9 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],11]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(RuInt.lmer, newdata = .)) %>%
        mutate(dens.weight.mean = 10^(predict(RuDWM.lmer, newdata = .))) %>%
        mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
        mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                        dens.percomp > 1 ~ 1.0001,
                                        TRUE ~ dens.percomp)) %>%
        mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                            dens.weight.mean > denscomp.max ~ denscomp.max, 
                                            TRUE ~ dens.weight.mean)) %>%
        mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
        mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                               TRUE ~ dens.weight.mean))
      
      #col 9 in CYP = dens.percomp | col 9 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,9] <- CurrentYrPredict[1,9] #dens.percomp
      siteenvdata[y,11] <- CurrentYrPredict[1,11] #dens.weight.mean
      siteenvdata[y,12] <- CurrentYrPredict[1,12] #dens.percomp.change
      siteenvdata[y,13] <- CurrentYrPredict[1,13] #dens.weight.meanDPC
    }
    
    Rudatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(Rudatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigRudatalist[[t]] <- siteenvdataagg
  
} 

#BigRuData#
Ru_FutIsPast = bigRudatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(Ru_FutIsPast,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Ru_FutureIsPast.csv")

#gc(bigRudatalist)

```


#Ruppia Community, No Action Scenario
100 simulation chunk will take some time!
```{r Ruppia CC_Shuff}

bigRudatalist = list()

for (t in 1:100){ 
  #t = 2
  Ru.OTB_CC = Ruppia.OneBay_CC_Shuff[Ruppia.OneBay_CC_Shuff$simnum_OB == t,] 
  
  Rudatalist = list()
  
  for(s in 1:length(ru_station)) { #length(zos_station)  , but some stations have NA problems so just 11 for now
    # s = 3
    #subset data by site
    siteenvdata <- Ru.OTB_CC[Ru.OTB_CC$STATION == ru_station[s],] 
    # intdendata <- ZDT2019[ZDT2019$STATION == zos_station[s],]
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrs)) { #HERE is basically why i needed the for loop, to start on 2:
      #  y = 3
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],9] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 9 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],11]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(RuInt.lmer, newdata = .)) %>%
        mutate(dens.weight.mean = 10^(predict(RuDWM.lmer, newdata = .))) %>%
        mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
        mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                        dens.percomp > 1 ~ 1.0001,
                                        TRUE ~ dens.percomp)) %>%
        mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                            dens.weight.mean > denscomp.max ~ denscomp.max, 
                                            TRUE ~ dens.weight.mean)) %>%
        mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
        mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                               TRUE ~ dens.weight.mean))
      
      #col 9 in CYP = dens.percomp | col 9 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,9] <- CurrentYrPredict[1,9] #dens.percomp
      siteenvdata[y,11] <- CurrentYrPredict[1,11] #dens.weight.mean
      siteenvdata[y,12] <- CurrentYrPredict[1,12] #dens.percomp.change
      siteenvdata[y,13] <- CurrentYrPredict[1,13] #dens.weight.meanDPC
    }
    
    Rudatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(Rudatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigRudatalist[[t]] <- siteenvdataagg
  
} 

Ru_CC.P1TB100_Shuff = bigRudatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(Ru_CC.P1TB100_Shuff,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Ru_CC.PredOneTrueBae.DWM100_Shuff.csv")
gc(bigRudatalist)

```

#Ruppia Community, Nutrient Reduction Scenario

```{r Ruppia WIP_Shuff}
bigRudatalist = list()

for (t in 1:100){ 
  #t = 2
  Ru.OTB_WIP = Ruppia.OneBay_WIP_Shuff[Ruppia.OneBay_WIP_Shuff$simnum_OB == t,] 
  
  Rudatalist = list()
  
  for(s in 1:length(ru_station)) { #length(zos_station)  , but some stations have NA problems so just 11 for now
    # s = 3
    #subset data by site
    siteenvdata <- Ru.OTB_WIP[Ru.OTB_WIP$STATION == ru_station[s],] 
    # intdendata <- ZDT2019[ZDT2019$STATION == zos_station[s],]
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrs)) { #HERE is basically why i needed the for loop, to start on 2:
      #y = 2
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],9] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 9 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],11]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(RuInt.lmer, newdata = .)) %>%
        mutate(dens.weight.mean = 10^(predict(RuDWM.lmer, newdata = .))) %>%
        mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
        mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                        dens.percomp > 1 ~ 1.0001,
                                        TRUE ~ dens.percomp)) %>%
        mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                            dens.weight.mean > denscomp.max ~ denscomp.max, 
                                            TRUE ~ dens.weight.mean)) %>%
        mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
        mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                               TRUE ~ dens.weight.mean))
      
      #col 9 in CYP = dens.percomp | col 9 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,9] <- CurrentYrPredict[1,9] #dens.percomp
      siteenvdata[y,11] <- CurrentYrPredict[1,11] #dens.weight.mean
      siteenvdata[y,12] <- CurrentYrPredict[1,12] #dens.percomp.change
      siteenvdata[y,13] <- CurrentYrPredict[1,13] #dens.weight.meanDPC
    }
    
    Rudatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(Rudatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigRudatalist[[t]] <- siteenvdataagg
  
} 

#BigRuData#
Ru_WIP.P1TB100_Shuff = bigRudatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(Ru_WIP.P1TB100_Shuff,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Ru_WIP.PredOneTrueBae.DWM100_Shuff.csv")


gc(bigRudatalist)
```

#Ruppia Community, Connowingo

```{r Ruppia CON_Shuff}
bigRudatalist = list()

for (t in 1:100){ 
  #t = 2
  Ru.OTB_CON = Ruppia.OneBay_CON_Shuff[Ruppia.OneBay_CON_Shuff$simnum_OB == t,] 
  
  Rudatalist = list()
  
  for(s in 1:length(ru_station)) { #length(zos_station)  , but some stations have NA problems so just 11 for now
    # s = 3
    #subset data by site
    siteenvdata <- Ru.OTB_CON[Ru.OTB_CON$STATION == ru_station[s],] 
    # intdendata <- ZDT2019[ZDT2019$STATION == zos_station[s],]
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrsCON)) { #HERE is basically why i needed the for loop, to start on 2:
      #y = 2
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],9] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 9 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],11]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(RuInt.lmer, newdata = .)) %>%
        mutate(dens.weight.mean = 10^(predict(RuDWM.lmer, newdata = .))) %>%
        mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
        mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                        dens.percomp > 1 ~ 1.0001,
                                        TRUE ~ dens.percomp)) %>%
        mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                            dens.weight.mean > denscomp.max ~ denscomp.max, 
                                            TRUE ~ dens.weight.mean)) %>%
        mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
        mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                               TRUE ~ dens.weight.mean))
      
      #col 9 in CYP = dens.percomp | col 9 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,9] <- CurrentYrPredict[1,9] #dens.percomp
      siteenvdata[y,11] <- CurrentYrPredict[1,11] #dens.weight.mean
      siteenvdata[y,12] <- CurrentYrPredict[1,12] #dens.percomp.change
      siteenvdata[y,13] <- CurrentYrPredict[1,13] #dens.weight.meanDPC
    }
    
    Rudatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(Rudatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigRudatalist[[t]] <- siteenvdataagg
  
} 

#BigRuData#
Ru_CON.P1TB100_Shuff = bigRudatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(Ru_CON.P1TB100_Shuff,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Ru_CON.PredOneTrueBae.DWM1000_Shuff.csv")


gc(bigRudatalist)
```

#Ruppia Community, Growth Scenario
```{r Ruppia GRO_Shuff}

bigRudatalist = list()

for (t in 1:100){ 
  #t = 2
  Ru.OTB_GRO = Ruppia.OneBay_GRO_Shuff[Ruppia.OneBay_GRO_Shuff$simnum_OB == t,] 
  
  Rudatalist = list()
  
  for(s in 1:length(ru_station)) { #length(zos_station)  , but some stations have NA problems so just 11 for now
    # s = 3
    #subset data by site
    siteenvdata <- Ru.OTB_GRO[Ru.OTB_GRO$STATION == ru_station[s],] 
    # intdendata <- ZDT2019[ZDT2019$STATION == zos_station[s],]
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrs)) { #HERE is basically why i needed the for loop, to start on 2:
      #  y = 3
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],9] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 9 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],11]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(RuInt.lmer, newdata = .)) %>%
        mutate(dens.weight.mean = 10^(predict(RuDWM.lmer, newdata = .))) %>%
        mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
        mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                        dens.percomp > 1 ~ 1.0001,
                                        TRUE ~ dens.percomp)) %>%
        mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                            dens.weight.mean > denscomp.max ~ denscomp.max, 
                                            TRUE ~ dens.weight.mean)) %>%
        mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
        mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                               TRUE ~ dens.weight.mean))
      
      #col 9 in CYP = dens.percomp | col 9 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,9] <- CurrentYrPredict[1,9] #dens.percomp
      siteenvdata[y,11] <- CurrentYrPredict[1,11] #dens.weight.mean
      siteenvdata[y,12] <- CurrentYrPredict[1,12] #dens.percomp.change
      siteenvdata[y,13] <- CurrentYrPredict[1,13] #dens.weight.meanDPC
    }
    
    Rudatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(Rudatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigRudatalist[[t]] <- siteenvdataagg
  
} 

Ru_GRO.P1TB100_Shuff = bigRudatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(Ru_GRO.P1TB100_Shuff,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Ru_GRO.PredOneTrueBae.DWM100_Shuff.csv")
gc(bigRudatalist)

```

#Ruppia Community, Never Action Scenario

```{r Ruppia NOACT_Shuff}
bigRudatalist = list()

for (t in 1:100){ 
  #t = 2
  Ru.OTB_NOACT = Ruppia.OneBay_NOACT_Shuff[Ruppia.OneBay_NOACT_Shuff$simnum_OB == t,] 
  
  Rudatalist = list()
  
  for(s in 1:length(ru_station)) { #length(zos_station)  , but some stations have NA problems so just 11 for now
    # s = 3
    #subset data by site
    siteenvdata <- Ru.OTB_NOACT[Ru.OTB_NOACT$STATION == ru_station[s],] 
    # intdendata <- ZDT2019[ZDT2019$STATION == zos_station[s],]
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrs)) { #HERE is basically why i needed the for loop, to start on 2:
      #y = 2
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],9] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 9 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],11]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(RuInt.lmer, newdata = .)) %>%
        mutate(dens.weight.mean = 10^(predict(RuDWM.lmer, newdata = .))) %>%
        mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
        mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                        dens.percomp > 1 ~ 1.0001,
                                        TRUE ~ dens.percomp)) %>%
        mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                            dens.weight.mean > denscomp.max ~ denscomp.max, 
                                            TRUE ~ dens.weight.mean)) %>%
        mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
        mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                               TRUE ~ dens.weight.mean))
      
      #col 9 in CYP = dens.percomp | col 9 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,9] <- CurrentYrPredict[1,9] #dens.percomp
      siteenvdata[y,11] <- CurrentYrPredict[1,11] #dens.weight.mean
      siteenvdata[y,12] <- CurrentYrPredict[1,12] #dens.percomp.change
      siteenvdata[y,13] <- CurrentYrPredict[1,13] #dens.weight.meanDPC
    }
    
    Rudatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(Rudatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigRudatalist[[t]] <- siteenvdataagg
  
} 

#BigRuData#
Ru_NOACT.P1TB100_Shuff = bigRudatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(Ru_NOACT.P1TB100_Shuff,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Ru_NOACT.PredOneTrueBae.DWM100_Shuff.csv")


gc(bigRudatalist)
```



#Mixed Mesohaline Community, No Action Scenario
100 simulation chunk will take some time!
```{r MixMeso Future Is Past}

MixedMesohaline.FutIsPast = FutureIsPast.df %>% filter(SpCluster == "MixedMeso") %>%
  select(simnum_OB, year, STATION, Chla.summe, Temp.summe, Temp.summin, TP.summe, TN.summe, Sal.sumy1max, dens.percomp, denscomp.max, dens.weight.mean) %>%
  arrange(simnum_OB, STATION, year) 

bigMMdatalist = list()

for (t in 1:100){ 
  #t = 2
  MM.OTB_CC = MixedMesohaline.FutIsPast[MixedMesohaline.FutIsPast$simnum_OB == t,] 
  
  MMdatalist = list()
  
  for(s in 1:length(MM_station)) { 
    # s = 3
    #subset data by site
    siteenvdata <- MM.OTB_CC[MM.OTB_CC$STATION == MM_station[s],] 
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrs)) { #HERE is basically why i needed the for loop, to start on 2:
       # y = 2
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],10] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 9 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],12]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(MMInt.lmer, newdata = .)) %>%
                mutate(dens.weight.mean = 10^(predict(MMDWM.lmer, newdata = .))) %>%
                mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
                mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                                dens.percomp > 1 ~ 1.0001,
                                                TRUE ~ dens.percomp)) %>%
                mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                                    dens.weight.mean > denscomp.max ~ denscomp.max, 
                                                    TRUE ~ dens.weight.mean)) %>%
                mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
                mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                                       TRUE ~ dens.weight.mean))
    
      
      #col 9 in CYP = dens.percomp | col 9 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,10] <- CurrentYrPredict[1,10] #dens.percomp
      siteenvdata[y,12] <- CurrentYrPredict[1,12] #dens.weight.mean
      siteenvdata[y,13] <- CurrentYrPredict[1,13] #dens.percomp.change
      siteenvdata[y,14] <- CurrentYrPredict[1,14] #dens.weight.meanDPC
      
    }
    
    MMdatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(MMdatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigMMdatalist[[t]] <- siteenvdataagg
  
}



MM_FutIsPast = bigMMdatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(MM_FutIsPast,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/MM_FutureIsPast.csv")

```


```{r MixMeso CC_Shuff}
bigMMdatalist = list()

for (t in 1:100){ 
  #t = 2
  MM.OTB_CC = MixMeso.OneBay_CC_Shuff[MixMeso.OneBay_CC_Shuff$simnum_OB == t,] 
  
  MMdatalist = list()
  
  for(s in 1:length(MM_station)) { 
    # s = 3
    #subset data by site
    siteenvdata <- MM.OTB_CC[MM.OTB_CC$STATION == MM_station[s],] 
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrs)) { #HERE is basically why i needed the for loop, to start on 2:
       # y = 2
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],10] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 9 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],12]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(MMInt.lmer, newdata = .)) %>%
                mutate(dens.weight.mean = 10^(predict(MMDWM.lmer, newdata = .))) %>%
                mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
                mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                                dens.percomp > 1 ~ 1.0001,
                                                TRUE ~ dens.percomp)) %>%
                mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                                    dens.weight.mean > denscomp.max ~ denscomp.max, 
                                                    TRUE ~ dens.weight.mean)) %>%
                mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
                mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                                       TRUE ~ dens.weight.mean))
    
      
      #col 9 in CYP = dens.percomp | col 9 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,10] <- CurrentYrPredict[1,10] #dens.percomp
      siteenvdata[y,12] <- CurrentYrPredict[1,12] #dens.weight.mean
      siteenvdata[y,13] <- CurrentYrPredict[1,13] #dens.percomp.change
      siteenvdata[y,14] <- CurrentYrPredict[1,14] #dens.weight.meanDPC
      
    }
    
    MMdatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(MMdatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigMMdatalist[[t]] <- siteenvdataagg
  
}


#BigMMData####
MM_CC.P1TB100_Shuff = bigMMdatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(MM_CC.P1TB100_Shuff,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/MM_CC.PredOneTrueBae.DWM100_Shuff.csv")

#biglist, not needed anymore.
gc(bigMMdatalist)



```

#Mixed Mesohaline Community, Nutrient Reduction Scenario

```{r MixMeso WIP_Shuff}

bigMMdatalist = list()

for (t in 1:100){ 
  #t = 2
  MM.OTB_WIP = MixMeso.OneBay_WIP_Shuff[MixMeso.OneBay_WIP_Shuff$simnum_OB == t,] 
  
  MMdatalist = list()
  
  for(s in 1:length(MM_station)) { 
    # s = 3
    #subset data by site
    siteenvdata <- MM.OTB_WIP[MM.OTB_WIP$STATION == MM_station[s],] 
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrs)) { #HERE is basically why i needed the for loop, to start on 2:
       # y = 2
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],10] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 9 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],12]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(MMInt.lmer, newdata = .)) %>%
                mutate(dens.weight.mean = 10^(predict(MMDWM.lmer, newdata = .))) %>%
                mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
                mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                                dens.percomp > 1 ~ 1.0001,
                                                TRUE ~ dens.percomp)) %>%
                mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                                    dens.weight.mean > denscomp.max ~ denscomp.max, 
                                                    TRUE ~ dens.weight.mean)) %>%
                mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
                mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                                       TRUE ~ dens.weight.mean))
    
      
      #col 9 in CYP = dens.percomp | col 9 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,10] <- CurrentYrPredict[1,10] #dens.percomp
      siteenvdata[y,12] <- CurrentYrPredict[1,12] #dens.weight.mean
      siteenvdata[y,13] <- CurrentYrPredict[1,13] #dens.percomp.change
      siteenvdata[y,14] <- CurrentYrPredict[1,14] #dens.weight.meanDPC
      
    }
    
    MMdatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(MMdatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigMMdatalist[[t]] <- siteenvdataagg
  
}


#BigMMData####
MM_WIP.P1TB100_Shuff = bigMMdatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(MM_WIP.P1TB100_Shuff,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/MM_WIP.PredOneTrueBae.DWM100_Shuff.csv")

#biglist, not needed anymore.
gc(bigMMdatalist)


```

#Mixed Meso Connowingo

```{r MixMeso CON_Shuff}

bigMMdatalist = list()

for (t in 1:100){ 
  #t = 2
  MM.OTB_CON = MixMeso.OneBay_CON_Shuff[MixMeso.OneBay_CON_Shuff$simnum_OB == t,] 
  
  MMdatalist = list()
  
  for(s in 1:length(MM_station)) { 
    # s = 3
    #subset data by site
    siteenvdata <- MM.OTB_CON[MM.OTB_CON$STATION == MM_station[s],] 
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrsCON)) { #HERE is basically why i needed the for loop, to start on 2:
       # y = 2
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],10] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 9 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],12]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(MMInt.lmer, newdata = .)) %>%
                mutate(dens.weight.mean = 10^(predict(MMDWM.lmer, newdata = .))) %>%
                mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
                mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                                dens.percomp > 1 ~ 1.0001,
                                                TRUE ~ dens.percomp)) %>%
                mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                                    dens.weight.mean > denscomp.max ~ denscomp.max, 
                                                    TRUE ~ dens.weight.mean)) %>%
                mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
                mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                                       TRUE ~ dens.weight.mean))
    
      
      #col 9 in CYP = dens.percomp | col 9 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,10] <- CurrentYrPredict[1,10] #dens.percomp
      siteenvdata[y,12] <- CurrentYrPredict[1,12] #dens.weight.mean
      siteenvdata[y,13] <- CurrentYrPredict[1,13] #dens.percomp.change
      siteenvdata[y,14] <- CurrentYrPredict[1,14] #dens.weight.meanDPC
      
    }
    
    MMdatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(MMdatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigMMdatalist[[t]] <- siteenvdataagg
  
}


#BigMMData####
MM_CON.P1TB100_Shuff = bigMMdatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(MM_CON.P1TB100_Shuff,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/MM_CON.PredOneTrueBae.DWM100_Shuff.csv")

#biglist, not needed anymore.
gc(bigMMdatalist)


```

#Mixed Meso Growth Scenario

```{r MixMeso GRO_Shuff}
bigMMdatalist = list()

for (t in 1:100){ 
  #t = 2
  MM.OTB_GRO = MixMeso.OneBay_GRO_Shuff[MixMeso.OneBay_GRO_Shuff$simnum_OB == t,] 
  
  MMdatalist = list()
  
  for(s in 1:length(MM_station)) { 
    # s = 3
    #subset data by site
    siteenvdata <- MM.OTB_GRO[MM.OTB_GRO$STATION == MM_station[s],] 
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrs)) { #HERE is basically why i needed the for loop, to start on 2:
       # y = 2
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],10] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 9 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],12]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(MMInt.lmer, newdata = .)) %>%
                mutate(dens.weight.mean = 10^(predict(MMDWM.lmer, newdata = .))) %>%
                mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
                mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                                dens.percomp > 1 ~ 1.0001,
                                                TRUE ~ dens.percomp)) %>%
                mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                                    dens.weight.mean > denscomp.max ~ denscomp.max, 
                                                    TRUE ~ dens.weight.mean)) %>%
                mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
                mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                                       TRUE ~ dens.weight.mean))
    
      
      #col 9 in CYP = dens.percomp | col 9 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,10] <- CurrentYrPredict[1,10] #dens.percomp
      siteenvdata[y,12] <- CurrentYrPredict[1,12] #dens.weight.mean
      siteenvdata[y,13] <- CurrentYrPredict[1,13] #dens.percomp.change
      siteenvdata[y,14] <- CurrentYrPredict[1,14] #dens.weight.meanDPC
      
    }
    
    MMdatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(MMdatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigMMdatalist[[t]] <- siteenvdataagg
  
}


#BigMMData####
MM_GRO.P1TB100_Shuff = bigMMdatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(MM_GRO.P1TB100_Shuff,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/MM_GRO.PredOneTrueBae.DWM100_Shuff.csv")

#biglist, not needed anymore.
gc(bigMMdatalist)



```

#Mixed Mesohaline Community, Never Action Scenario

```{r MixMeso NOACT_Shuff}

bigMMdatalist = list()

for (t in 1:100){ 
  #t = 2
  MM.OTB_NOACT = MixMeso.OneBay_NOACT_Shuff[MixMeso.OneBay_NOACT_Shuff$simnum_OB == t,] 
  
  MMdatalist = list()
  
  for(s in 1:length(MM_station)) { 
    # s = 3
    #subset data by site
    siteenvdata <- MM.OTB_NOACT[MM.OTB_NOACT$STATION == MM_station[s],] 
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrs)) { #HERE is basically why i needed the for loop, to start on 2:
       # y = 2
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],10] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 9 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],12]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(MMInt.lmer, newdata = .)) %>%
                mutate(dens.weight.mean = 10^(predict(MMDWM.lmer, newdata = .))) %>%
                mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
                mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                                dens.percomp > 1 ~ 1.0001,
                                                TRUE ~ dens.percomp)) %>%
                mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                                    dens.weight.mean > denscomp.max ~ denscomp.max, 
                                                    TRUE ~ dens.weight.mean)) %>%
                mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
                mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                                       TRUE ~ dens.weight.mean))
    
      
      #col 9 in CYP = dens.percomp | col 9 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,10] <- CurrentYrPredict[1,10] #dens.percomp
      siteenvdata[y,12] <- CurrentYrPredict[1,12] #dens.weight.mean
      siteenvdata[y,13] <- CurrentYrPredict[1,13] #dens.percomp.change
      siteenvdata[y,14] <- CurrentYrPredict[1,14] #dens.weight.meanDPC
      
    }
    
    MMdatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(MMdatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigMMdatalist[[t]] <- siteenvdataagg
  
}


#BigMMData####
MM_NOACT.P1TB100_Shuff = bigMMdatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(MM_NOACT.P1TB100_Shuff,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/MM_NOACT.PredOneTrueBae.DWM100_Shuff.csv")

#biglist, not needed anymore.
gc(bigMMdatalist)


```


#Fresh Community, No Action Scenario
100 simulation chunk will take some time!

```{r Fresh Future Is Past}
Fresh.FutIsPast = FutureIsPast.df %>% filter(SpCluster == "Fresh") %>%
  select(simnum_OB, year, STATION, Chla.summe, Temp.summe, Temp.summax, Temp.sumy1me, TP.summe, TN.summe, Sal.summe, dens.percomp, denscomp.max, dens.weight.mean) %>%
  arrange(simnum_OB, STATION, year) 

bigFdatalist = list()

for (t in 1:50){ 
  #t = 2
  F.OTB_CC = Fresh.FutIsPast[Fresh.FutIsPast$simnum_OB == t,] 
  
  Fdatalist = list()
  
  for(s in 1:length(F_station)) { #length(zos_station)  , but some stations have NA problems so just 11 for now
    # s = 1
    #subset data by site
    siteenvdata <- F.OTB_CC[F.OTB_CC$STATION == F_station[s],] 
    # intdendata <- ZDT2019[ZDT2019$STATION == zos_station[s],]
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrs)) { #HERE is basically why i needed the for loop, to start on 2:
      # y = 2
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],11] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 11 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],13]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(FInt.lmer, newdata = .)) %>%
        mutate(dens.weight.mean = 10^(predict(FDWM.lmer, newdata = .))) %>%
        mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
        mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                        dens.percomp > 1 ~ 1.0001,
                                        TRUE ~ dens.percomp)) %>%
        mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                            dens.weight.mean > denscomp.max ~ denscomp.max, 
                                            TRUE ~ dens.weight.mean)) %>%
        mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
        mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                               TRUE ~ dens.weight.mean))
      
      
      #col 9 in CYP = dens.percomp | col 9 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,11] <- CurrentYrPredict[1,11] #dens.percomp
      siteenvdata[y,13] <- CurrentYrPredict[1,13] #dens.percomp.change
      siteenvdata[y,14] <- CurrentYrPredict[1,14] #dens.weight.meanDPC
      siteenvdata[y,15] <- CurrentYrPredict[1,15] #dens.weight.mean
      
      
    }
    
    Fdatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(Fdatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigFdatalist[[t]] <- siteenvdataagg
  
}

F_FutIsPast = bigFdatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(F_FutIsPast,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/F_FutureIsPast.csv")

```

#Fresh No Action
```{r Fresh CC_Shuff}

bigFdatalist = list()

for (t in 1:100){ 
  #t = 2
  F.OTB_CC = Fresh.OneBay_CC_Shuff[Fresh.OneBay_CC_Shuff$simnum_OB == t,] 
  
  Fdatalist = list()
  
  for(s in 1:length(F_station)) { #length(zos_station)  , but some stations have NA problems so just 11 for now
    # s = 1
    #subset data by site
    siteenvdata <- F.OTB_CC[F.OTB_CC$STATION == F_station[s],] 
    # intdendata <- ZDT2019[ZDT2019$STATION == zos_station[s],]
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrs)) { #HERE is basically why i needed the for loop, to start on 2:
      # y = 2
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],11] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 11 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],13]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(FInt.lmer, newdata = .)) %>%
        mutate(dens.weight.mean = 10^(predict(FDWM.lmer, newdata = .))) %>%
        mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
        mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                        dens.percomp > 1 ~ 1.0001,
                                        TRUE ~ dens.percomp)) %>%
        mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                            dens.weight.mean > denscomp.max ~ denscomp.max, 
                                            TRUE ~ dens.weight.mean)) %>%
        mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
        mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                               TRUE ~ dens.weight.mean))
      
      
      #col 9 in CYP = dens.percomp | col 9 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,11] <- CurrentYrPredict[1,11] #dens.percomp
      siteenvdata[y,13] <- CurrentYrPredict[1,13] #dens.percomp.change
      siteenvdata[y,14] <- CurrentYrPredict[1,14] #dens.weight.meanDPC
      siteenvdata[y,15] <- CurrentYrPredict[1,15] #dens.weight.mean
      
      
    }
    
    Fdatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(Fdatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigFdatalist[[t]] <- siteenvdataagg
  
}


#BigFData####
F_CC.P1TB100_Shuff = bigFdatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(F_CC.P1TB100_Shuff,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/F_CC.PredOneTrueBae.DWM100_Shuff.csv")

gc(bigFdatalist)

```

#Fresh Community, Nutrient Reduction Scenario

```{r Fresh WIP_Shuff}
bigFdatalist = list()

for (t in 1:100){ 
  #t = 2
  F.OTB_WIP = Fresh.OneBay_WIP_Shuff[Fresh.OneBay_WIP_Shuff$simnum_OB == t,] 
  
  Fdatalist = list()
  
  for(s in 1:length(F_station)) { #length(zos_station)  , but some stations have NA problems so just 11 for now
    # s = 1
    #subset data by site
    siteenvdata <- F.OTB_WIP[F.OTB_WIP$STATION == F_station[s],] 
    # intdendata <- ZDT2019[ZDT2019$STATION == zos_station[s],]
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrs)) { #HERE is basically why i needed the for loop, to start on 2:
      # y = 2
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],11] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 11 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],13]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(FInt.lmer, newdata = .)) %>%
        mutate(dens.weight.mean = 10^(predict(FDWM.lmer, newdata = .))) %>%
        mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
        mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                        dens.percomp > 1 ~ 1.0001,
                                        TRUE ~ dens.percomp)) %>%
        mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                            dens.weight.mean > denscomp.max ~ denscomp.max, 
                                            TRUE ~ dens.weight.mean)) %>%
        mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
        mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                               TRUE ~ dens.weight.mean))
      
      
      #col 9 in CYP = dens.percomp | col 9 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,11] <- CurrentYrPredict[1,11] #dens.percomp
      siteenvdata[y,13] <- CurrentYrPredict[1,13] #dens.percomp.change
      siteenvdata[y,14] <- CurrentYrPredict[1,14] #dens.weight.meanDPC
      siteenvdata[y,15] <- CurrentYrPredict[1,15] #dens.weight.mean
      
      
    }
    
    Fdatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(Fdatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigFdatalist[[t]] <- siteenvdataagg
  
}


#BigFData####
F_WIP.P1TB100_Shuff = bigFdatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(F_WIP.P1TB100_Shuff,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/F_WIP.PredOneTrueBae.DWM100_Shuff.csv")


gc(bigFdatalist)
```

#Fresh Community, Connowingo infill

```{r Fresh CON_Shuff}
bigFdatalist = list()

for (t in 1:100){ 
  #t = 2
  F.OTB_CON = Fresh.OneBay_CON_Shuff[Fresh.OneBay_CON_Shuff$simnum_OB == t,] 
  
  Fdatalist = list()
  
  for(s in 1:length(F_station)) { #length(zos_station)  , but some stations have NA problems so just 11 for now
    # s = 1
    #subset data by site
    siteenvdata <- F.OTB_CON[F.OTB_CON$STATION == F_station[s],] 
    # intdendata <- ZDT2019[ZDT2019$STATION == zos_station[s],]
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrsCON)) { #HERE is basically why i needed the for loop, to start on 2:
      # y = 2
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],11] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 11 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],13]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(FInt.lmer, newdata = .)) %>%
        mutate(dens.weight.mean = 10^(predict(FDWM.lmer, newdata = .))) %>%
        mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
        mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                        dens.percomp > 1 ~ 1.0001,
                                        TRUE ~ dens.percomp)) %>%
        mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                            dens.weight.mean > denscomp.max ~ denscomp.max, 
                                            TRUE ~ dens.weight.mean)) %>%
        mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
        mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                               TRUE ~ dens.weight.mean))
      
      
      #col 9 in CYP = dens.percomp | col 9 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,11] <- CurrentYrPredict[1,11] #dens.percomp
      siteenvdata[y,13] <- CurrentYrPredict[1,13] #dens.percomp.change
      siteenvdata[y,14] <- CurrentYrPredict[1,14] #dens.weight.meanDPC
      siteenvdata[y,15] <- CurrentYrPredict[1,15] #dens.weight.mean
      
      
    }
    
    Fdatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(Fdatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigFdatalist[[t]] <- siteenvdataagg
  
}


#BigFData####
F_CON.P1TB100_Shuff = bigFdatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(F_CON.P1TB100_Shuff,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/F_CON.PredOneTrueBae.DWM100_Shuff.csv")


gc(bigFdatalist)
```

#Fresh Community, Growth Scen
```{r Fresh GRO_Shuff}

bigFdatalist = list()

for (t in 1:100){ 
  #t = 2
  F.OTB_GRO = Fresh.OneBay_GRO_Shuff[Fresh.OneBay_GRO_Shuff$simnum_OB == t,] 
  
  Fdatalist = list()
  
  for(s in 1:length(F_station)) { #length(zos_station)  , but some stations have NA problems so just 11 for now
    # s = 1
    #subset data by site
    siteenvdata <- F.OTB_GRO[F.OTB_GRO$STATION == F_station[s],] 
    # intdendata <- ZDT2019[ZDT2019$STATION == zos_station[s],]
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrs)) { #HERE is basically why i needed the for loop, to start on 2:
      # y = 2
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],11] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 11 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],13]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(FInt.lmer, newdata = .)) %>%
        mutate(dens.weight.mean = 10^(predict(FDWM.lmer, newdata = .))) %>%
        mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
        mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                        dens.percomp > 1 ~ 1.0001,
                                        TRUE ~ dens.percomp)) %>%
        mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                            dens.weight.mean > denscomp.max ~ denscomp.max, 
                                            TRUE ~ dens.weight.mean)) %>%
        mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
        mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                               TRUE ~ dens.weight.mean))
      
      
      #col 9 in CYP = dens.percomp | col 9 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,11] <- CurrentYrPredict[1,11] #dens.percomp
      siteenvdata[y,13] <- CurrentYrPredict[1,13] #dens.percomp.change
      siteenvdata[y,14] <- CurrentYrPredict[1,14] #dens.weight.meanDPC
      siteenvdata[y,15] <- CurrentYrPredict[1,15] #dens.weight.mean
      
      
    }
    
    Fdatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(Fdatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigFdatalist[[t]] <- siteenvdataagg
  
}


#BigFData####
F_GRO.P1TB100_Shuff = bigFdatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(F_GRO.P1TB100_Shuff,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/F_GRO.PredOneTrueBae.DWM100_Shuff.csv")

gc(bigFdatalist)

```

#Fresh Community, Never Axtion Scenario

```{r Fresh NOACT_Shuff}
bigFdatalist = list()

for (t in 1:100){ 
  #t = 2
  F.OTB_NOACT = Fresh.OneBay_NOACT_Shuff[Fresh.OneBay_NOACT_Shuff$simnum_OB == t,] 
  
  Fdatalist = list()
  
  for(s in 1:length(F_station)) { #length(zos_station)  , but some stations have NA problems so just 11 for now
    # s = 1
    #subset data by site
    siteenvdata <- F.OTB_NOACT[F.OTB_NOACT$STATION == F_station[s],] 
    # intdendata <- ZDT2019[ZDT2019$STATION == zos_station[s],]
    siteenvdata$dens.percomp.change = NA  
    siteenvdata$dens.weight.meanDPC = NA
    siteenvdata <- as.data.frame(siteenvdata)
    
    
    for(y in 2:length(future_yrs)) { #HERE is basically why i needed the for loop, to start on 2:
      # y = 2
      dens.percomp.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],11] #this var needed for predict(), should be dens.percomp (i.e. y1) #col 11 is dens.percomp
      dens.weight.mean.y1 <- siteenvdata[siteenvdata$year == future_yrs[y-1],13]
      thisyrinfo <- siteenvdata[siteenvdata$year == future_yrs[y],] #y-1 for dpcy1 above, y for this yr
      
      CurrentYrPredict <- thisyrinfo %>% #kept my tidy code but needed? idk
        mutate(dens.percomp.change = predict(FInt.lmer, newdata = .)) %>%
        mutate(dens.weight.mean = 10^(predict(FDWM.lmer, newdata = .))) %>%
        mutate(dens.percomp = dens.percomp.change + dens.percomp.y1) %>%
        mutate(dens.percomp = case_when(dens.percomp < 0 ~ 0.0001, 
                                        dens.percomp > 1 ~ 1.0001,
                                        TRUE ~ dens.percomp)) %>%
        mutate(dens.weight.mean = case_when(dens.weight.mean < 0 ~ 0.0001,
                                            dens.weight.mean > denscomp.max ~ denscomp.max, 
                                            TRUE ~ dens.weight.mean)) %>%
        mutate(dens.weight.meanDPC = dens.percomp*denscomp.max) %>%
        mutate(dens.weight.meanDPC = case_when(dens.weight.mean < 0 ~ 0.0001, 
                                               TRUE ~ dens.weight.mean))
      
      
      #col 9 in CYP = dens.percomp | col 9 in siteenvdata
      #col 13 in CYP = dens.percomp.change | col 13 in siteenvdata 
      #col 14 in CYP = dens.weight.mean | col 14 in siteenvdata 
      
      siteenvdata[y,11] <- CurrentYrPredict[1,11] #dens.percomp
      siteenvdata[y,13] <- CurrentYrPredict[1,13] #dens.percomp.change
      siteenvdata[y,14] <- CurrentYrPredict[1,14] #dens.weight.meanDPC
      siteenvdata[y,15] <- CurrentYrPredict[1,15] #dens.weight.mean
      
      
    }
    
    Fdatalist[[s]] <- siteenvdata
    
  }
  
  # rbind together all objects in datalist
  siteenvdataagg <- bind_rows(Fdatalist)
  # add column for simnum and populate with t (outer loop iteration)
  #siteenvdataagg$simnum <- rep(t, length(siteenvdataagg[,1]))
  # write big dataframe to big data list 
  bigFdatalist[[t]] <- siteenvdataagg
  
}


#BigFData####
F_NOACT.P1TB100_Shuff = bigFdatalist %>% 
  map_dfr(as_tibble, .name_repair = "universal")

vroom_write(F_NOACT.P1TB100_Shuff,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/F_NOACT.PredOneTrueBae.DWM100_Shuff.csv")


gc(bigFdatalist)
```



#SIMULATIONS HERE!!!####
#Load in Future Seagrass Predictions: Visualize simulations
```{r Load All SHUFF Community Predictions}

#Pre final presentation meeting, I ran the CONs and it was called .DWM20_Shuff
#Just to keep things separate but equal for now, 

Zo_CC.P1TB100_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Zo_CC.PredOneTrueBae.DWM100_Shuff.csv")
Zo_WIP.P1TB100_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Zo_WIP.PredOneTrueBae.DWM100_Shuff.csv")
Zo_CON.P1TB100_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Zo_CON.PredOneTrueBae.DWM100_Shuff.csv")
Zo_GRO.P1TB100_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Zo_GRO.PredOneTrueBae.DWM100_Shuff.csv")
Zo_NOACT.P1TB100_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Zo_NOACT.PredOneTrueBae.DWM100_Shuff.csv")
Zo_FutIsPast = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Zo_FutureIsPast.csv")

Ru_CC.P1TB100_Shuff= vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Ru_CC.PredOneTrueBae.DWM100_Shuff.csv")
Ru_WIP.P1TB100_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Ru_WIP.PredOneTrueBae.DWM100_Shuff.csv")
Ru_CON.P1TB100_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Ru_CON.PredOneTrueBae.DWM100_Shuff.csv")
Ru_GRO.P1TB100_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Ru_GRO.PredOneTrueBae.DWM100_Shuff.csv")
Ru_NOACT.P1TB100_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Ru_NOACT.PredOneTrueBae.DWM100_Shuff.csv")
Ru_FutIsPast = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/Ru_FutureIsPast.csv")

MM_CC.P1TB100_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/MM_CC.PredOneTrueBae.DWM100_Shuff.csv")
MM_WIP.P1TB100_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/MM_WIP.PredOneTrueBae.DWM100_Shuff.csv")
MM_CON.P1TB100_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/MM_CON.PredOneTrueBae.DWM100_Shuff.csv")
MM_GRO.P1TB100_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/MM_GRO.PredOneTrueBae.DWM100_Shuff.csv")
MM_NOACT.P1TB100_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/MM_NOACT.PredOneTrueBae.DWM100_Shuff.csv")
MM_FutIsPast = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/MM_FutureIsPast.csv")


F_CC.P1TB100_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/F_CC.PredOneTrueBae.DWM100_Shuff.csv")
F_WIP.P1TB100_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/F_WIP.PredOneTrueBae.DWM100_Shuff.csv")
F_CON.P1TB100_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/F_CON.PredOneTrueBae.DWM100_Shuff.csv")
F_GRO.P1TB100_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/F_GRO.PredOneTrueBae.DWM100_Shuff.csv")
F_NOACT.P1TB100_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/F_NOACT.PredOneTrueBae.DWM100_Shuff.csv")
F_FutIsPast = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/F_FutureIsPast.csv")

```



#Visualize the Future Environment: Temperature Rise of 2 dec C

```{r Temperature over time graph Zostera community}
Zo_WIP.P1TB100_Shuff %>% 
  group_by(simnum_OB, year) %>%
  summarize(dens.weight.mean = sum(dens.weight.mean, na.rm = T), 
            across(Chla.spme:Temp.spme, ~mean(., na.rm = T))) %>% 
ggplot(data = . , aes(x = year, y = dens.weight.mean)) + #%>% filter(between(simnum_OB, 1, 3)) ) +
  stat_summary(aes(group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "lightgreen") +
 # stat_summary(aes(x = year, y = Temp.sumy1med), geom = "line", size = 1, color = "brown") +
    stat_smooth(method = "gam", size = 1, color = "darkgreen") +
  stat_summary(data = ZoDensWQsem.No0_Predict,
               aes(x = year, y = dens.weight.mean), fun.data = "mean_se", geom = "line", size = .9) #+
  #facet_wrap(~STATION, scales = "free_y")


ggplot(data = Zo_NOACT.P1TB100_Shuff) + #%>% filter(between(simnum_OB, 1, 2))) + 
  stat_summary(aes(x = year, y = dens.weight.mean), fun.data = "mean_se", geom = "line", size = .9) +
  geom_line(aes(x = year, y = dens.weight.mean, group = simnum_OB)) +
    stat_summary(data = SAVCommDensWQ_ForPred.with0s %>% filter(SpCluster == "Zostera"), aes(x = year, y = dens.weight.mean), fun.data = "mean_se", geom = "line", size = .9) +
  facet_wrap(~STATION, scales = "free_y")


```

#Visualize the Future Environment: Nutrient Management Scenarios

```{r Nutrients over time graph Ruppia community}

ggplot(data = Ru_CON.P1TB100_Shuff) + #%>% filter(between(simnum_OB, 1, 2))) + 
  stat_summary(aes(x = year, y = dens.weight.mean), fun.data = "mean_se", geom = "line", size = .9) +
  geom_line(aes(x = year, y = dens.weight.mean, group = simnum_OB)) +
    stat_summary(data = SAVCommDensWQ_ForPred.with0s %>% filter(SpCluster == "Ruppia"), aes(x = year, y = dens.weight.mean), fun.data = "mean_se", geom = "line", size = .9) +
  facet_wrap(~STATION, scales = "free_y")

ggplot(data = F_WIP.P1TB100 %>% filter(between(simnum_OB, 69, 78)) %>% filter(str_detect(STATION, "^CB"))) +
  #geom_point(aes(x = year, y = dens.percomp.change, group = STATION, color = simnum_OB), position = position_jitter()) +
  stat_summary(aes(x = year, y = TN.summe, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .4, color = "lightgreen") +
  stat_summary(aes(x = year, y = TN.summe), geom = "line", size = 2, color = "cyan3") +
  stat_smooth(aes(x = year, y = TN.summe), method = "lm", size = 1, color = "darkgreen") +
    stat_summary(data = F_CC.P1TB100 %>% filter(between(simnum_OB, 69, 78)) %>% filter(str_detect(STATION, "^CB")),
               aes(x = year, y = TN.summe, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .4, color = "red") +
    stat_smooth(data = F_CC.P1TB100 %>% filter(between(simnum_OB, 69, 78)) %>% filter(str_detect(STATION, "^CB")), 
              aes(x = year, y = TN.summe), method = "lm", size = 2, color = "brown") +
  stat_summary(data = FreshDensWQsem.No0_Predict %>% filter(str_detect(STATION, "^CB")),
               aes(x = year, y = TN.summe), fun.data = "mean_se", geom = "line", size = 1) +
    stat_smooth(data = FreshDensWQsem.No0_Predict %>% filter(str_detect(STATION, "^CB")), 
              aes(x = year, y = TN.summe), method = "lm", size = 1, color = "darkgreen") +
  facet_wrap(~simnum_OB)

ggplot(data = Ru_WIP.P1TB100 %>% filter(between(simnum_OB, 69, 78)) %>% filter(str_detect(STATION, "^CB"))) +
  #geom_point(aes(x = year, y = dens.percomp.change, group = STATION, color = simnum_OB), position = position_jitter()) +
  stat_summary(aes(x = year, y = TN.spme, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .4, color = "lightgreen") +
  stat_summary(aes(x = year, y = TN.spme), geom = "line", size = 1.5, color = "cyan3") +
  stat_smooth(aes(x = year, y = TN.spme), method = "lm", size = 1, color = "darkgreen") +
    stat_summary(data = Ru_CC.P1TB100 %>% filter(between(simnum_OB, 69, 78)) %>% filter(str_detect(STATION, "^CB")),
               aes(x = year, y = TN.spme, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .4, color = "red") +
    stat_summary(data = Ru_CC.P1TB100 %>% filter(between(simnum_OB, 69, 78)) %>% filter(str_detect(STATION, "^CB")) , 
                 aes(x = year, y = TN.spme), geom = "line", size = 1.5, color = "brown") +
    stat_smooth(data = Ru_CC.P1TB100 %>% filter(between(simnum_OB, 69, 78)) %>% filter(str_detect(STATION, "^CB")), 
              aes(x = year, y = TN.spme), method = "lm", size = 1.5, color = "brown") +
  stat_summary(data = RuDensWQsem.No0_Predict %>% filter(str_detect(STATION, "^CB")),
               aes(x = year, y = TN.spme), fun.data = "mean_se", geom = "line", size = 1.5, color = "black") +
    stat_smooth(data = RuDensWQsem.No0_Predict %>% filter(str_detect(STATION, "^CB")), 
              aes(x = year, y = TN.spme), method = "lm", size = 1, color = "darkgreen") +
  facet_wrap(~STATION, scales = "free_y")

#whats up w the cyclical shit
#ANSWER: dont look at the mean of every fucking simulation bc youll just get the data you fed into it w no error. you dipshit
ggplot(data = Ru_WIP.PredOneTrueBae.DWM)+ #%>% filter(between(simnum_OB, 1, 3)) ) +
  stat_summary(aes(x = year, y = TN.spme, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "lightgreen") +
    stat_summary(data = Ru_CC.PredOneTrueBae.DWM, 
                 aes(x = year, y = TN.spme, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "cyan1") +
      stat_summary(data = Ru_CC.PredOneTrueBae.DWM, 
                 aes(x = year, y = TN.spme), fun.data = "mean_se", geom = "line", size = 1, color = "black") +
    stat_summary(aes(x = year, y = TN.spme), fun.data = "mean_se", geom = "line", size = 1, color = "brown") +
   # stat_smooth(data = Ru_CC.PredOneTrueBae.DWM,
    #            aes(x = year, y = TN.spme), method = "gam", size = 1, color = "cyan2") +
   # geom_labelsmooth(data = FullBaeFuture.Area_ByScen, aes(x = year, y = Area.total, color = Scen, label = Scen),
  #                 method = "lm", boxlinewidth = 0, size = 7) +
  stat_summary(data = RuDensWQsem.No0_Predict,
               aes(x = year, y = TN.spme), fun.data = "mean_se", geom = "line", size = .9) #+
  #facet_wrap(~STATION, scales = "free_y")

ggplot(data = F_WIP.PredOneTrueBae.DWM)+ #%>% filter(between(simnum_OB, 1, 3)) ) +
  stat_summary(aes(x = year, y = TN.summe, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "lightgreen") +
    stat_summary(data = F_CC.PredOneTrueBae.DWM, 
                 aes(x = year, y = TN.summe, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "cyan1") +
      stat_summary(data = F_CC.PredOneTrueBae.DWM, 
                 aes(x = year, y = TN.summe), fun.data = "mean_se", geom = "line", size = 1, color = "black") +
    stat_summary(aes(x = year, y = TN.summe), fun.data = "mean_se", geom = "line", size = 1, color = "brown") +
   # stat_smooth(data = Ru_CC.PredOneTrueBae.DWM,
    #            aes(x = year, y = TN.spme), method = "gam", size = 1, color = "cyan2") +
   # geom_labelsmooth(data = FullBaeFuture.Area_ByScen, aes(x = year, y = Area.total, color = Scen, label = Scen),
  #                 method = "lm", boxlinewidth = 0, size = 7) +
  stat_summary(data = FreshDensWQsem.No0_Predict,
               aes(x = year, y = TN.summe), fun.data = "mean_se", geom = "line", size = .9) #+

ggplot(data = Zo_WIP.PredOneTrueBae.DWM)+ #%>% filter(between(simnum_OB, 1, 3)) ) +
  stat_summary(aes(x = year, y = TN.spme, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "lightgreen") +
    stat_summary(data = Zo_CC.PredOneTrueBae.DWM, 
                 aes(x = year, y = TN.spme, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "cyan1") +
      stat_summary(data = Zo_CC.PredOneTrueBae.DWM, 
                 aes(x = year, y = TN.spme), fun.data = "mean_se", geom = "line", size = 1, color = "black") +
    stat_summary(aes(x = year, y = TN.spme), fun.data = "mean_se", geom = "line", size = 1, color = "brown") +
   # stat_smooth(data = Ru_CC.PredOneTrueBae.DWM,
    #            aes(x = year, y = TN.spme), method = "gam", size = 1, color = "cyan2") +
   # geom_labelsmooth(data = FullBaeFuture.Area_ByScen, aes(x = year, y = Area.total, color = Scen, label = Scen),
  #                 method = "lm", boxlinewidth = 0, size = 7) +
  stat_summary(data = ZoDensWQsem.No0_Predict,
               aes(x = year, y = TN.spme), fun.data = "mean_se", geom = "line", size = .9) #

```

```{r Visualize Shuff}

full_join(Ru_CC.P1TB100_Shuff %>% add_column(Scen = "No Action"), 
          Ru_WIP.P1TB100_Shuff %>% add_column(Scen = "Nutrient Reduction")) %>%
    filter(simnum_OB %in% c(1, 2)) %>%
  group_by(simnum_OB, year, Scen) %>%
  summarize(dwm = sum(dens.weight.mean)) %>%
  ggplot(data = .) +
  stat_summary(aes(x = year, y = dwm, color = Scen), fun.data = "mean_cl_boot", geom = "pointrange", size = .6) +
  stat_summary(aes(x = year, y = dwm, color = Scen), geom = "line", size = 1) +
  stat_smooth(aes(x = year, y = dwm, color = Scen), method = "lm", size = 1) +
  stat_summary(data = RuDensWQsem.No0_Predict,
               aes(x = year, y = dens.weight.mean), fun = sum, geom = "line", size = .9)  +
  facet_wrap(~simnum_OB)


ggplot(data = Ru_WIP.P1TB100_Shuff) +
  stat_summary(aes(x = year, y = dens.weight.mean), fun.data = "mean_cl_boot", geom = "pointrange", size = .6, color = "pink") +
  stat_summary(aes(x = year, y = dens.weight.mean), geom = "line", size = 1, color = "brown") +
  stat_smooth(aes(x = year, y = dens.weight.mean), method = "lm", size = 1, color = "red") +
    stat_summary(data = Ru_CC.P1TB100_Shuff,
               aes(x = year, y = dens.weight.mean), fun.data = "mean_cl_boot", geom = "pointrange", size = .9, color = "darkgreen") +
      stat_summary(data = Ru_CC.P1TB100_Shuff,
               aes(x = year, y = dens.weight.mean), fun.data = "mean_se", geom = "line", size = .9, color = "darkgreen") +
    stat_smooth(data = Ru_CC.P1TB100_Shuff, 
              aes(x = year, y = dens.weight.mean), method = "lm", size = 1, color = "lightgreen") +
  stat_summary(data = RuDensWQsem.No0_Predict,
               aes(x = year, y = dens.weight.mean), fun.data = "mean_se", geom = "line", size = .9) +
    stat_smooth(data = RuDensWQsem.No0_Predict, 
              aes(x = year, y = dens.weight.mean), method = "lm", size = 1) #+
  #facet_wrap(~simnum_OB)



#TN Spme data looks pretty damn good
ggplot(data = Ru_WIP.P1TB100_Shuff %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^CB7"))) +
  stat_summary(aes(x = year, y = TN.spme, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "lightgreen") +
  stat_summary(aes(x = year, y = TN.spme), geom = "line", size = 1, color = "green") +
  stat_smooth(aes(x = year, y = TN.spme), method = "lm", size = 1, color = "darkgreen") +
  stat_summary(data = Ru_FutIsPast %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^CB7")), 
               aes(x = year, y = TN.spme, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "purple") +
  stat_summary(data = Ru_FutIsPast %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^CB7")), aes(x = year, y = TN.spme), geom = "line", size = 1, color = "purple") +
  stat_smooth(data = Ru_FutIsPast %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^CB7")), aes(x = year, y = TN.spme), method = "lm", size = 1, color = "darkmagenta") +
    stat_summary(data = Ru_CC.P1TB100_Shuff %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^CB7")),
               aes(x = year, y = TN.spme, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "orange") +
  stat_summary(data = Ru_CC.P1TB100_Shuff %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^CB7")), 
               aes(x = year, y = TN.spme), geom = "line", size = 1, color = "darkorange") +
    stat_smooth(data = Ru_CC.P1TB100_Shuff %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^CB7")), 
              aes(x = year, y = TN.spme), method = "lm", size = 1, color = "chocolate1") +
  stat_summary(data = RuDensWQsem.No0_Predict %>% filter(str_detect(STATION, "^CB7")), 
              aes(x = year, y = TN.spme), geom = "line", size = 1, color = "blueviolet") +
    stat_smooth(data = RuDensWQsem.No0_Predict %>% filter(str_detect(STATION, "^CB7")), 
              aes(x = year, y = TN.spme), method = "lm", size = 1, color = "darkmagenta") +
  facet_grid(STATION~simnum_OB)





```

```{r look at DWM mean shuff STATION~simnum}

#this chunk makes me think that shuff is looking sexy and great
ggplot(data = Zo_WIP.P1TB100_Shuff %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^WE"))) +
  stat_summary(aes(x = year, y = dens.weight.mean, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "lightgreen") +
  stat_summary(aes(x = year, y = dens.weight.mean), geom = "line", size = 1, color = "green") +
  stat_smooth(aes(x = year, y = dens.weight.mean), method = "lm", size = 1, color = "darkgreen") +
  stat_summary(data = Zo_FutIsPast %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^WE")), 
               aes(x = year, y = dens.weight.mean, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "purple") +
  stat_summary(data = Zo_FutIsPast %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^WE")), aes(x = year, y = dens.weight.mean), geom = "line", size = 1, color = "purple") +
  stat_smooth(data = Zo_FutIsPast %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^WE")), aes(x = year, y = dens.weight.mean), method = "lm", size = 1, color = "darkmagenta") +
    stat_summary(data = Zo_CC.P1TB100_Shuff %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^WE")),
               aes(x = year, y = dens.weight.mean, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "orange") +
  stat_summary(data = Zo_CC.P1TB100_Shuff %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^WE")), 
               aes(x = year, y = dens.weight.mean), geom = "line", size = 1, color = "darkorange") +
    stat_smooth(data = Zo_CC.P1TB100_Shuff %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^WE")), 
              aes(x = year, y = dens.weight.mean), method = "lm", size = 1, color = "chocolate1") +
  stat_summary(data = ZoDensWQsem.No0_Predict %>% filter(str_detect(STATION, "^WE")), 
              aes(x = year, y = dens.weight.mean), geom = "line", size = 1, color = "blueviolet") +
    stat_smooth(data = ZoDensWQsem.No0_Predict %>% filter(str_detect(STATION, "^WE")), 
              aes(x = year, y = dens.weight.mean), method = "lm", size = 1, color = "darkmagenta") +
  facet_grid(STATION~simnum_OB, scales = "free_y")

ggplot(data = Ru_WIP.P1TB100_Shuff %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^CB7"))) +
  stat_summary(aes(x = year, y = dens.weight.mean, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "lightgreen") +
  stat_summary(aes(x = year, y = dens.weight.mean), geom = "line", size = 1, color = "green") +
  stat_smooth(aes(x = year, y = dens.weight.mean), method = "lm", size = 1, color = "darkgreen") +
  stat_summary(data = Ru_FutIsPast %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^CB7")), 
               aes(x = year, y = dens.weight.mean, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "purple") +
  stat_summary(data = Ru_FutIsPast %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^CB7")), aes(x = year, y = dens.weight.mean), geom = "line", size = 1, color = "purple") +
  stat_smooth(data = Ru_FutIsPast %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^CB7")), aes(x = year, y = dens.weight.mean), method = "lm", size = 1, color = "darkmagenta") +
    stat_summary(data = Ru_CC.P1TB100_Shuff %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^CB7")),
               aes(x = year, y = dens.weight.mean, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "orange") +
  stat_summary(data = Ru_CC.P1TB100_Shuff %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^CB7")), 
               aes(x = year, y = dens.weight.mean), geom = "line", size = 1, color = "darkorange") +
    stat_smooth(data = Ru_CC.P1TB100_Shuff %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^CB7")), 
              aes(x = year, y = dens.weight.mean), method = "lm", size = 1, color = "chocolate1") +
  stat_summary(data = RuDensWQsem.No0_Predict %>% filter(str_detect(STATION, "^CB7")), 
              aes(x = year, y = dens.weight.mean), geom = "line", size = 1, color = "blueviolet") +
    stat_smooth(data = RuDensWQsem.No0_Predict %>% filter(str_detect(STATION, "^CB7")), 
              aes(x = year, y = dens.weight.mean), method = "lm", size = 1, color = "darkmagenta") +
  facet_grid(STATION~simnum_OB, scales = "free_y")

ggplot(data = MM_WIP.P1TB100_Shuff %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^WT"))) +
  stat_summary(aes(x = year, y = dens.weight.mean, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "lightgreen") +
  stat_summary(aes(x = year, y = dens.weight.mean), geom = "line", size = 1, color = "green") +
  stat_smooth(aes(x = year, y = dens.weight.mean), method = "lm", size = 1, color = "darkgreen") +
  stat_summary(data = MM_FutIsPast %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^WT")), 
               aes(x = year, y = dens.weight.mean, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "purple") +
  stat_summary(data = MM_FutIsPast %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^WT")), aes(x = year, y = dens.weight.mean), geom = "line", size = 1, color = "purple") +
  stat_smooth(data = MM_FutIsPast %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^WT")), aes(x = year, y = dens.weight.mean), method = "lm", size = 1, color = "darkmagenta") +
    stat_summary(data = MM_CC.P1TB100_Shuff %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^WT")),
               aes(x = year, y = dens.weight.mean, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "orange") +
  stat_summary(data = MM_CC.P1TB100_Shuff %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^WT")), 
               aes(x = year, y = dens.weight.mean), geom = "line", size = 1, color = "darkorange") +
    stat_smooth(data = MM_CC.P1TB100_Shuff %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^WT")), 
              aes(x = year, y = dens.weight.mean), method = "lm", size = 1, color = "chocolate1") +
  stat_summary(data = MMDensWQsem.No0_Predict %>% filter(str_detect(STATION, "^WT")), 
              aes(x = year, y = dens.weight.mean), geom = "line", size = 1, color = "blueviolet") +
    stat_smooth(data = MMDensWQsem.No0_Predict %>% filter(str_detect(STATION, "^WT")), 
              aes(x = year, y = dens.weight.mean), method = "lm", size = 1, color = "darkmagenta") +
  facet_grid(STATION~simnum_OB, scales = "free_y")

ggplot(data = F_WIP.P1TB100_Shuff %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^CB"))) +
  stat_summary(aes(x = year, y = dens.weight.mean, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "lightgreen") +
  stat_summary(aes(x = year, y = dens.weight.mean), geom = "line", size = 1, color = "green") +
  stat_smooth(aes(x = year, y = dens.weight.mean), method = "lm", size = 1, color = "darkgreen") +
  stat_summary(data = F_FutIsPast %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^CB")), 
               aes(x = year, y = dens.weight.mean, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "purple") +
  stat_summary(data = F_FutIsPast %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^CB")), aes(x = year, y = dens.weight.mean), geom = "line", size = 1, color = "purple") +
  stat_smooth(data = F_FutIsPast %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^CB")), aes(x = year, y = dens.weight.mean), method = "lm", size = 1, color = "darkmagenta") +
    stat_summary(data = F_CC.P1TB100_Shuff %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^CB")),
               aes(x = year, y = dens.weight.mean, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "orange") +
  stat_summary(data = F_CC.P1TB100_Shuff %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^CB")), 
               aes(x = year, y = dens.weight.mean), geom = "line", size = 1, color = "darkorange") +
    stat_smooth(data = F_CC.P1TB100_Shuff %>% filter(between(simnum_OB, 1, 3)) %>% filter(str_detect(STATION, "^CB")), 
              aes(x = year, y = dens.weight.mean), method = "lm", size = 1, color = "chocolate1") +
  stat_summary(data = FreshDensWQsem.No0_Predict %>% filter(str_detect(STATION, "^CB")), 
              aes(x = year, y = dens.weight.mean), geom = "line", size = 1, color = "blueviolet") +
    stat_smooth(data = FreshDensWQsem.No0_Predict %>% filter(str_detect(STATION, "^CB")), 
              aes(x = year, y = dens.weight.mean), method = "lm", size = 1, color = "darkmagenta") + 
  #  scale_color_manual(values = scencol) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "right") +
  facet_grid(STATION~simnum_OB, scales = "free_y") 


```

```{r CB1.1 (Flats)}

ggplot(data = F_WIP.P1TB100_Shuff %>% filter(between(simnum_OB, 88, 93)) %>% filter(str_detect(STATION, "^CB1.1"))) +
  stat_summary(aes(x = year, y = dens.weight.mean, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "lightgreen") +
  stat_summary(aes(x = year, y = dens.weight.mean), geom = "line", size = 1, color = "green") +
  stat_summary(data = F_FutIsPast %>% filter(between(simnum_OB, 88, 93)) %>% filter(str_detect(STATION, "^CB1.1")), 
               aes(x = year, y = dens.weight.mean, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "purple") +
  stat_summary(data = F_FutIsPast %>% filter(between(simnum_OB, 88, 93)) %>% filter(str_detect(STATION, "^CB1.1")), aes(x = year, y = dens.weight.mean), geom = "line", size = 1, color = "purple") +
    stat_summary(data = F_CC.P1TB100_Shuff %>% filter(between(simnum_OB, 88, 93)) %>% filter(str_detect(STATION, "^CB1.1")),
               aes(x = year, y = dens.weight.mean, group = simnum_OB), fun.data = "mean_se", geom = "line", size = .6, color = "orange") +
  stat_summary(data = F_CC.P1TB100_Shuff %>% filter(between(simnum_OB, 88, 93)) %>% filter(str_detect(STATION, "^CB1.1")), 
               aes(x = year, y = dens.weight.mean), geom = "line", size = 1, color = "darkorange") +
  stat_summary(data = FreshDensWQsem.No0_Predict %>% filter(str_detect(STATION, "^CB1.1")), 
              aes(x = year, y = dens.weight.mean), geom = "line", size = 1, color = "blueviolet") +
    stat_smooth(data = FreshDensWQsem.No0_Predict %>% filter(str_detect(STATION, "^CB1.1")), 
              aes(x = year, y = dens.weight.mean), method = "lm", size = 1, color = "darkmagenta") +
    theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "right") +
  facet_wrap(~simnum_OB, scales = "free_y")


```



```{r RUN THIS POST SIMULATION: summary DFs for all communities}

#Just some little formulae to convert dens.weight.mean to Area
dwm.to.HA_Zo = lmer(SAVArea ~ dens.weight.mean + (1|STATION), data = SAVCommDensWQ_ForPred.with0s %>% 
                    filter(SpCluster == "Zostera"))
dwm.to.HA_Zo2020 = SAVCommDensWQ_ForPred.with0s %>% filter(SpCluster == "Zostera") %>% filter(year == 2020) %>% group_by(STATION) %>% 
  mutate(dwm = case_when(dens.weight.mean < 1 ~ mean(dens.weight.mean:dens.weight.mean.y1, na.rm = T), 
                         .default = dens.weight.mean ), 
         area = case_when(SAVArea < 1 ~ 0.001, 
                         .default = SAVArea )) %>% 
  summarise(dwm.convert = case_when(area/dwm == "Inf" ~ 0.01, 
                                    .default = area/dwm)) %>% 
  add_column(SpCluster = "Zostera")
dwm.to.HA_Ru = lmer(SAVArea ~ dens.weight.mean + (1|STATION), data = SAVCommDensWQ_ForPred.with0s %>% 
                    filter(SpCluster == "Ruppia"))
dwm.to.HA_Ru2020 = SAVCommDensWQ_ForPred.with0s %>% filter(SpCluster == "Ruppia") %>% filter(year == 2020) %>% group_by(STATION) %>% 
  mutate(dwm = case_when(dens.weight.mean < 1 ~ mean(dens.weight.mean:dens.weight.mean.y1, na.rm = T), 
                         .default = dens.weight.mean ), 
         area = case_when(SAVArea < 1 ~ 0.001, 
                         .default = SAVArea )) %>% 
  summarise(dwm.convert = case_when(area/dwm == "Inf" ~ 0.01, 
                                    .default = area/dwm)) %>% 
  add_column(SpCluster = "Ruppia")
dwm.to.HA_MM = lmer(SAVArea ~ dens.weight.mean + (1|STATION), data = SAVCommDensWQ_ForPred.with0s %>% 
                    filter(SpCluster == "MixedMeso"))
dwm.to.HA_MM2020 = SAVCommDensWQ_ForPred.with0s %>% filter(SpCluster == "MixedMeso") %>% filter(year == 2020) %>% group_by(STATION) %>% 
  mutate(dwm = case_when(dens.weight.mean < 1 ~ mean(dens.weight.mean:dens.weight.mean.y1, na.rm = T), 
                         .default = dens.weight.mean ), 
         area = case_when(SAVArea < 1 ~ 0.001, 
                         .default = SAVArea )) %>% 
  summarise(dwm.convert = case_when(area/dwm == "Inf" ~ 0.01, 
                                    .default = area/dwm)) %>% 
  add_column(SpCluster = "MixedMeso")
dwm.to.HA_F = lmer(SAVArea ~ dens.weight.mean + (1|STATION), data = SAVCommDensWQ_ForPred.with0s %>% 
                   filter(SpCluster == "Fresh"))
dwm.to.HA_F2020 = SAVCommDensWQ_ForPred.with0s %>% filter(SpCluster == "Fresh") %>% filter(year == 2020) %>% group_by(STATION) %>% 
  mutate(dwm = case_when(dens.weight.mean < 1 ~ mean(dens.weight.mean:dens.weight.mean.y1, na.rm = T), 
                         .default = dens.weight.mean ), 
         area = case_when(SAVArea < 1 ~ 0.001, 
                         .default = SAVArea )) %>% 
  summarise(dwm.convert = case_when(area/dwm == "Inf" ~ 0.01, 
                                    .default = area/dwm)) %>% 
  add_column(SpCluster = "Fresh")

convertdwmtoHA = bind_rows(dwm.to.HA_F2020, dwm.to.HA_MM2020, dwm.to.HA_Ru2020, dwm.to.HA_Zo2020) %>% 
  mutate(dwm.convert = case_when(dwm.convert < 1 ~ 1, 
                                 .default = dwm.convert))



#Shuff DWM20####
ZoFuture.DWM100_Shuff = bind_rows(
  Zo_CC.P1TB100_Shuff %>% 
    add_column(Scen = "No Further Reductions", SpCluster = "Zostera"), 
  Zo_WIP.P1TB100_Shuff %>% 
    add_column(Scen = "Nutrient Reduction", SpCluster = "Zostera"), 
  Zo_FutIsPast %>% 
    add_column(Scen = "Future is Past", SpCluster = "Zostera"), 
  Zo_CON.P1TB100_Shuff %>% 
    add_column(Scen = "All Nutrient Reductions", SpCluster = "Zostera"),
  Zo_GRO.P1TB100_Shuff %>% 
    add_column(Scen = "No Climate Change", SpCluster = "Zostera"), 
  Zo_NOACT.P1TB100_Shuff %>% 
    add_column(Scen = "Never Reductions", SpCluster = "Zostera")
  ) 

RuFuture.DWM100_Shuff = bind_rows(
  Ru_CC.P1TB100_Shuff %>% 
    add_column(Scen = "No Further Reductions", SpCluster = "Ruppia"), 
  Ru_WIP.P1TB100_Shuff %>% 
    add_column(Scen = "Nutrient Reduction", SpCluster = "Ruppia"), 
  Ru_FutIsPast %>% 
    add_column(Scen = "Future is Past", SpCluster = "Ruppia"), 
  Ru_CON.P1TB100_Shuff %>% 
    add_column(Scen = "All Nutrient Reductions", SpCluster = "Ruppia"),
  Ru_GRO.P1TB100_Shuff %>% 
    add_column(Scen = "No Climate Change", SpCluster = "Ruppia"), 
  Ru_NOACT.P1TB100_Shuff %>% 
    add_column(Scen = "Never Reductions", SpCluster = "Ruppia")
  ) 

MMFuture.DWM100_Shuff = bind_rows(
  MM_CC.P1TB100_Shuff %>% 
    add_column(Scen = "No Further Reductions", SpCluster = "MixedMeso"), 
  MM_WIP.P1TB100_Shuff %>% 
    add_column(Scen = "Nutrient Reduction", SpCluster = "MixedMeso"), 
  MM_FutIsPast %>% 
    add_column(Scen = "Future is Past", SpCluster = "MixedMeso"), 
  MM_CON.P1TB100_Shuff %>% 
    add_column(Scen = "All Nutrient Reductions", SpCluster = "MixedMeso"),
  MM_GRO.P1TB100_Shuff %>% 
    add_column(Scen = "No Climate Change", SpCluster = "MixedMeso"), 
  MM_NOACT.P1TB100_Shuff %>% 
    add_column(Scen = "Never Reductions", SpCluster = "MixedMeso")
  ) 

FFuture.DWM100_Shuff = bind_rows(
  F_CC.P1TB100_Shuff %>% 
    add_column(Scen = "No Further Reductions", SpCluster = "Fresh"), 
  F_WIP.P1TB100_Shuff %>% 
    add_column(Scen = "Nutrient Reduction", SpCluster = "Fresh"), 
  F_FutIsPast %>% 
    add_column(Scen = "Future is Past", SpCluster = "Fresh"), 
  F_CON.P1TB100_Shuff %>% 
    add_column(Scen = "All Nutrient Reductions", SpCluster = "Fresh"),
  F_GRO.P1TB100_Shuff %>% 
    add_column(Scen = "No Climate Change", SpCluster = "Fresh"), 
  F_NOACT.P1TB100_Shuff %>% 
    add_column(Scen = "Never Reductions", SpCluster = "Fresh")
  ) 


#FullBaeFuture.ALLDATA100####
#Merged all three communities. Unclear how useful this will be
#FullBaeFuture.ALLDATA100 = full_join(FFuture.DWM100, RuFuture.DWM100) %>% 
#  full_join(ZoFuture.DWM100) %>% full_join(MMFuture.DWM100) %>%
#  select(simnum_OB, STATION, year, SpCluster, Scen, Area, dens.weight.mean, dens.percomp.change, dens.percomp, denscomp.max, dens.weight.meanDPC, everything())

#vroom_write(FullBaeFuture.ALLDATA100,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/FullBaeFuture.ALLDATA100.csv")


#So there are Env mismatches here that make a join kind of silly. I'm going to leave this since we've been using it but i want to grab just the density data 
##FullBAeShuff####
FullBaeFuture.ALLDATA100_Shuff = bind_rows(FFuture.DWM100_Shuff, RuFuture.DWM100_Shuff, ZoFuture.DWM100_Shuff, MMFuture.DWM100_Shuff) %>% 
  ungroup() %>%
  select(simnum_OB, STATION, year, SpCluster, Scen, dens.weight.mean, dens.percomp.change, dens.percomp, denscomp.max, dens.weight.meanDPC, everything()) %>% 
  full_join(convertdwmtoHA) %>%
  group_by(SpCluster, STATION) %>% 
  mutate(Area = dens.weight.mean*dwm.convert) %>%
  drop_na(Scen) #one of these from PIS0033
  #filter(!Scen == "No CC No Action")

vroom_write(FullBaeFuture.ALLDATA100_Shuff,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/FullBaeFuture.ALLDATA100_Shuff.csv")


FullBaeFuture.SAVOnly_Shuff = FullBaeFuture.ALLDATA100_Shuff %>%
  select(simnum_OB, year, STATION, Scen, SpCluster, Area, dens.weight.mean) %>%
  ungroup()   #%>%
  #filter(!Scen == "No CC No Action")

vroom_write(FullBaeFuture.SAVOnly_Shuff,"/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/FullBaeFuture.SAVOnly_Shuff.csv")
  
#summarize(across(Area:dens.weight.mean, ~mean(.x, na.rm = T))) #mean isnt prob necessary here but i wanted to make sure that we didnt have repetitives.
natabfull = FullBaeFuture.ALLDATA100_Shuff %>% 
  group_by(Scen, SpCluster) %>% 
              summarise(across(everything(), ~sum(is.na(.x))))
View(natabfull)
#lots of these NAs come from having 0 dwm in 2020. however its just a couple statioins and actually as im typing its prob from that typo i found where we didnt correct that 2020 data in Fresh and Mixed Meso! So maybe this will be fixed w the new runthru

natab = FullBaeFuture.SAVOnly_Shuff %>% 
  group_by(Scen, SpCluster) %>% 
              summarise(across(everything(), ~sum(is.na(.x))))
View(natab)

View(FFuture.DWM100_Shuff %>% filter(simnum_OB == 57))

```



```{r Check out Ru Shuff simulations ENV}
ru_TN.one = 
RuFuture.DWM100_Shuff %>% filter(STATION == "EE3.1") %>%
  group_by(simnum_OB, year, Scen) %>% 
  summarize(dens.weight.mean = sum(dens.weight.mean, na.rm = T), 
            Temp.spme = mean(Temp.spme, na.rm = T), 
            TN.spme = mean(TN.spme, na.rm = T)) %>%
ggplot(data = .) + #%>% filter(between(simnum_OB, 1, 3)) ) +
  stat_summary(aes(x = year, y = TN.spme, color = Scen, group = simnum_OB), geom = "line", linewidth = .5) +
  stat_summary(aes(x = year, y = TN.spme), geom = "line", linewidth = 2) +
 # stat_smooth(aes(x = year, y = Temp.spme), method = "gam", linewidth = 3) +
  stat_summary(data = RuDensWQsem.No0_Predict %>% filter(STATION == "EE3.1"),
               aes(x = year, y = TN.spme), fun.data = mean_se, geom = "line", linewidth = 2) +
  theme_bw(base_size=20) + 
  #ylim(0, 2) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "") +
  facet_wrap(~Scen)
ru_TN.one

ru_TN.all = 
RuFuture.DWM100_Shuff %>% 
  group_by(simnum_OB, year, Scen) %>% 
  summarize(dens.weight.mean = sum(dens.weight.mean, na.rm = T), 
            Temp.spme = mean(Temp.spme, na.rm = T), 
            TN.spme = mean(TN.spme, na.rm = T)) %>%
ggplot(data = .) + #%>% filter(between(simnum_OB, 1, 3)) ) +
  #stat_summary(aes(x = year, y = TN.spme, color = Scen, group = simnum_OB), geom = "line", linewidth = .5) +
  stat_summary(aes(x = year, y = TN.spme, color = Scen), geom = "line", linewidth = 2) +
  stat_smooth(aes(x = year, y = TN.spme, color = Scen), method = "lm", linewidth = 3) +
  stat_summary(data = RuDensWQsem.No0_Predict,
               aes(x = year, y = TN.spme), fun.data = mean_se, geom = "line", linewidth = 2) +
  theme_bw(base_size=20) + 
  #ylim(0, 2) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "right")
ru_TN.all

ZoFuture.DWM100_Shuff %>% filter(STATION == "CB5.4W") %>%
  group_by(simnum_OB, year, Scen) %>% 
  summarize(dens.weight.mean = sum(dens.weight.mean, na.rm = T), 
            Sal.summed = mean(Sal.summed, na.rm = T), 
            TN.spme = mean(TN.spme, na.rm = T)) %>%
ggplot(data = .) + #%>% filter(between(simnum_OB, 1, 3)) ) +
  stat_summary(aes(x = year, y = Sal.summed, color = Scen, group = simnum_OB), geom = "line", linewidth = .5) +
  stat_summary(aes(x = year, y = Sal.summed), geom = "line", linewidth = 2) +
  stat_smooth(aes(x = year, y = Sal.summed), method = "lm", linewidth = 3) +
  stat_summary(data = ZoDensWQsem.No0_Predict %>% filter(STATION == "CB5.4W"),
               aes(x = year, y = Sal.summed), fun.data = "mean_se", geom = "line", linewidth = 2, color = "pink") +
  theme_bw(base_size=20) + 
 # ylim(0, 2) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
       # panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "right") +
  facet_wrap(~Scen)
```


```{r Peep  Shuff Simulations}

fTn_shuff = 
FFuture.DWM100_Shuff %>% filter(STATION == "TF2.4") %>%
  group_by(simnum_OB, year, Scen) %>% 
  summarize(dens.weight.mean = sum(dens.weight.mean, na.rm = T), 
            Temp.spme = mean(Temp.summe, na.rm = T), 
            TN.spme = mean(TN.summe, na.rm = T)) %>%
ggplot(data = .) + #%>% filter(between(simnum_OB, 1, 3)) ) +
  stat_summary(aes(x = year, y = TN.spme, color = Scen, group = simnum_OB), geom = "line", linewidth = .5) +
  stat_summary(aes(x = year, y = TN.spme), geom = "line", linewidth = 2) +
 # stat_smooth(aes(x = year, y = Temp.spme), method = "gam", linewidth = 3) +
  stat_summary(data = FreshDensWQsem.No0_Predict %>% filter(STATION == "TF2.4"),
               aes(x = year, y = TN.summe), fun.data = mean_se, geom = "line", linewidth = 2) +
  theme_bw(base_size=20) + 
  #ylim(0, 2) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "") +
  facet_wrap(~Scen)

fTn_unshuff = 
FFuture.DWM100 %>% filter(STATION == "TF2.4") %>%
  group_by(simnum_OB, year, Scen) %>% 
  summarize(dens.weight.mean = sum(dens.weight.mean, na.rm = T), 
            Temp.spme = mean(Temp.summe, na.rm = T), 
            TN.spme = mean(TN.summe, na.rm = T)) %>%
ggplot(data = .) + #%>% filter(between(simnum_OB, 1, 3)) ) +
  stat_summary(aes(x = year, y = TN.spme, color = Scen, group = simnum_OB), geom = "line", linewidth = .5) +
  stat_summary(aes(x = year, y = TN.spme), geom = "line", linewidth = 2) +
 # stat_smooth(aes(x = year, y = Temp.spme), method = "gam", linewidth = 3) +
  stat_summary(data = FreshDensWQsem.No0_Predict %>% filter(STATION == "TF2.4"),
               aes(x = year, y = TN.summe), fun.data = mean_se, geom = "line", linewidth = 2) +
  theme_bw(base_size=20) + 
 # ylim(0, 2) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "") +
  facet_wrap(~Scen)

(fTn_shuff/fTn_unshuff)  

fshuff = FFuture.DWM100_Shuff %>% filter(STATION == "CB1.1") %>%
  group_by(simnum_OB, year, Scen) %>%
  summarize(Area = sum(dens.weight.mean, na.rm = T)) %>% ungroup() %>%
  ggplot(.) + 
  stat_summary(aes(x = year, y = Area, color = Scen), geom = "line", linewidth = 2) +
  stat_summary(data = SAVCommDensWQ_ForPred.with0s %>% filter(SpCluster == "Fresh") %>% filter(STATION == "CB1.1"),
               aes(x = year, y = dens.weight.mean), fun = sum, geom = "line", linewidth = 2) +
    labs(y = "Area", x = "") +
  theme_bw(base_size=32) + 
  scale_x_continuous(breaks=seq(1980, 2070, 10)) +
  scale_color_manual(values = c("brown1", "darkgoldenrod", "lightblue")) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "right")

funshuff = FFuture.DWM100 %>% filter(STATION == "CB1.1") %>% filter(between(simnum_OB, 1, 20)) %>%
  group_by(simnum_OB, year, Scen) %>%
  summarize(Area = sum(dens.weight.mean, na.rm = T)) %>% ungroup() %>%
  ggplot(.) + 
  stat_summary(aes(x = year, y = Area, color = Scen), geom = "line", linewidth = 2) +
  stat_summary(data = SAVCommDensWQ_ForPred.with0s %>% filter(SpCluster == "Fresh") %>% filter(STATION == "CB1.1"),
               aes(x = year, y = dens.weight.mean), fun = sum, geom = "line", linewidth = 2) +
    labs(y = "Area", x = "") +
  theme_bw(base_size=32) + 
  scale_x_continuous(breaks=seq(1980, 2070, 10)) +
  scale_color_manual(values = c("brown1", "darkgoldenrod", "lightblue")) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")
fshuff/funshuff

fdwm_shuff = 
FFuture.DWM100_Shuff %>% filter(between(simnum_OB, 1, 20)) %>%
  group_by(simnum_OB, year, Scen) %>% 
  summarize(dens.weight.mean = sum(dens.weight.mean, na.rm = T), 
            Temp.summe = mean(Temp.summe, na.rm = T), 
            Temp.summax = mean(Temp.summax, na.rm = T),
            TN.summe = mean(TN.summe, na.rm = T)) %>%
ggplot(data = .) + #%>% filter(between(simnum_OB, 1, 3)) ) +
  stat_summary(aes(x = year, y = dens.weight.mean, color = Scen, group = simnum_OB), geom = "line", linewidth = .5) +
  stat_summary(aes(x = year, y = dens.weight.mean), geom = "line", linewidth = 2) +
  stat_smooth(aes(x = year, y = dens.weight.mean), method = "gam", linewidth = 3) +
  stat_summary(data = FreshDensWQsem.No0_Predict,
               aes(x = year, y = dens.weight.mean), fun = sum, geom = "line", linewidth = 2, color = "pink") +
  theme_bw(base_size=20) + 
 # ylim(0, 2) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
       # panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "") +
  facet_wrap(~Scen)

fdwm_shuff2 = 
FFuture.DWM20_Shuff %>% #filter(between(simnum_OB, 1, 200)) %>%
  group_by(simnum_OB, year, Scen) %>% 
  summarize(dens.weight.mean = sum(dens.weight.mean, na.rm = T), 
            Temp.summe = mean(Temp.summe, na.rm = T), 
            Temp.summax = mean(Temp.summax, na.rm = T),
            TN.summe = mean(TN.summe, na.rm = T)) %>%
ggplot(data = .) + #%>% filter(between(simnum_OB, 1, 3)) ) +
  stat_summary(aes(x = year, y = dens.weight.mean, color = Scen, group = simnum_OB), geom = "line", linewidth = .5) +
  stat_summary(aes(x = year, y = dens.weight.mean), geom = "line", linewidth = 2) +
  stat_smooth(aes(x = year, y = dens.weight.mean), method = "gam", linewidth = 3) +
  stat_summary(data = FreshDensWQsem.No0_Predict,
               aes(x = year, y = dens.weight.mean), fun = sum, geom = "line", linewidth = 2, color = "pink") +
  theme_bw(base_size=20) + 
 # ylim(0, 2) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
       # panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "") +
  facet_wrap(~Scen)

fdwm_unshuff = 
FFuture.DWM100 %>% filter(between(simnum_OB, 1, 20)) %>%
  group_by(simnum_OB, year, Scen) %>% 
  summarize(dens.weight.mean = sum(dens.weight.mean, na.rm = T), 
            Temp.summe = mean(Temp.summe, na.rm = T), 
            Temp.summax = mean(Temp.summax, na.rm = T),
            TN.summe = mean(TN.summe, na.rm = T)) %>%
ggplot(data = .) + #%>% filter(between(simnum_OB, 1, 3)) ) +
  stat_summary(aes(x = year, y = dens.weight.mean, color = Scen, group = simnum_OB), geom = "line", linewidth = .5) +
  stat_summary(aes(x = year, y = dens.weight.mean), geom = "line", linewidth = 2) +
  stat_smooth(aes(x = year, y = dens.weight.mean), method = "gam", linewidth = 3) +
  stat_summary(data = FreshDensWQsem.No0_Predict,
               aes(x = year, y = dens.weight.mean), fun = sum, geom = "line", linewidth = 2, color = "pink") +
  theme_bw(base_size=20) + 
#  ylim(0, 2) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        #panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "") +
  facet_wrap(~Scen)

fdwm_shuff2/fdwm_shuff

mdwm_shuff2 = 
MMFuture.DWM100_Shuff %>% filter(between(simnum_OB, 1, 20)) %>%
  group_by(simnum_OB, year, Scen) %>% 
  summarize(dens.weight.mean = sum(dens.weight.mean, na.rm = T), 
            Temp.summe = mean(Temp.summe, na.rm = T), 
            TP.summe = mean(TP.summe, na.rm = T),
            TN.summe = mean(TN.summe, na.rm = T)) %>%
ggplot(data = .) + #%>% filter(between(simnum_OB, 1, 3)) ) +
  stat_summary(aes(x = year, y = dens.weight.mean, color = Scen, group = simnum_OB), geom = "line", linewidth = .5) +
  stat_summary(aes(x = year, y = dens.weight.mean), geom = "line", linewidth = 2) +
  stat_smooth(aes(x = year, y = dens.weight.mean), method = "gam", linewidth = 3) +
  stat_summary(data = MMDensWQsem.No0_Predict,
               aes(x = year, y = dens.weight.mean), fun = sum, geom = "line", linewidth = 2, color = "pink") +
  theme_bw(base_size=20) + 
 # ylim(0, 2) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
       # panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "") +
  facet_wrap(~Scen)

mdwm_unshuff = 
MMFuture.DWM100 %>% filter(between(simnum_OB, 1, 20)) %>%
  group_by(simnum_OB, year, Scen) %>% 
  summarize(dens.weight.mean = sum(dens.weight.mean, na.rm = T), 
            Temp.summe = mean(Temp.summe, na.rm = T), 
            TP.summe = mean(TP.summe, na.rm = T),
            TN.summe = mean(TN.summe, na.rm = T)) %>%
ggplot(data = .) + #%>% filter(between(simnum_OB, 1, 3)) ) +
  stat_summary(aes(x = year, y = dens.weight.mean, color = Scen, group = simnum_OB), geom = "line", linewidth = .5) +
  stat_summary(aes(x = year, y = dens.weight.mean), geom = "line", linewidth = 2) +
  stat_smooth(aes(x = year, y = dens.weight.mean), method = "gam", linewidth = 3) +
  stat_summary(data = MMDensWQsem.No0_Predict,
               aes(x = year, y = dens.weight.mean), fun = sum, geom = "line", linewidth = 2, color = "pink") +
  theme_bw(base_size=20) + 
 # ylim(0, 2) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
       # panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "") +
  facet_wrap(~Scen)

mdwm_shuff2/mdwm_unshuff

rudwm_shuff = 
RuFuture.DWM100_Shuff %>% #filter(between(simnum_OB, 45, 65)) %>%
  group_by(simnum_OB, year, Scen) %>% 
  summarize(dens.weight.mean = sum(dens.weight.mean, na.rm = T), 
            Temp.spme = mean(Temp.spme, na.rm = T), 
            TN.spme = mean(TN.spme, na.rm = T)) %>%
ggplot(data = .) + #%>% filter(between(simnum_OB, 1, 3)) ) +
  stat_summary(aes(x = year, y = dens.weight.mean, color = Scen, group = simnum_OB), geom = "line", linewidth = .5) +
  stat_summary(aes(x = year, y = dens.weight.mean), geom = "line", linewidth = 2) +
 # stat_smooth(aes(x = year, y = dens.weight.mean), method = "lm", linewidth = 3) +
  stat_summary(data = RuDensWQsem.No0_Predict,
               aes(x = year, y = dens.weight.mean), fun = sum, geom = "line", linewidth = 2, color = "pink") +
  theme_bw(base_size=20) + 
 # ylim(0, 2) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
       # panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "right") +
  facet_wrap(~Scen)

rudwm_unshuff = 
RuFuture.DWM100 %>% #filter(between(simnum_OB, 1, 20)) %>%
  group_by(simnum_OB, year, Scen) %>% 
  summarize(dens.weight.mean = sum(dens.weight.mean, na.rm = T), 
            Temp.spme = mean(Temp.spme, na.rm = T), 
            TN.spme = mean(TN.spme, na.rm = T)) %>%
ggplot(data = .) + #%>% filter(between(simnum_OB, 1, 3)) ) +
  stat_summary(aes(x = year, y = dens.weight.mean, color = Scen, group = simnum_OB), geom = "line", linewidth = .5) +
  stat_summary(aes(x = year, y = dens.weight.mean), geom = "line", linewidth = 2) +
  stat_smooth(aes(x = year, y = dens.weight.mean), method = "lm", linewidth = 3) +
  stat_summary(data = RuDensWQsem.No0_Predict,
               aes(x = year, y = dens.weight.mean), fun = sum, geom = "line", linewidth = 2, color = "pink") +
  theme_bw(base_size=20) + 
#  ylim(0, 2) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        #panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "") +
  facet_wrap(~Scen)

rudwm_shuff/rudwm_unshuff

zdwm_shuff = 
ZoFuture.DWM100_Shuff %>% #filter(between(simnum_OB, 45, 65)) %>%
  group_by(simnum_OB, year, Scen) %>% 
  summarize(dens.weight.mean = sum(dens.weight.mean, na.rm = T), 
            Temp.spmed = mean(Temp.spmed, na.rm = T), 
            TN.spme = mean(TN.spme, na.rm = T)) %>%
ggplot(data = .) + #%>% filter(between(simnum_OB, 1, 3)) ) +
  stat_summary(aes(x = year, y = dens.weight.mean, color = Scen, group = simnum_OB), geom = "line", linewidth = .5) +
  stat_summary(aes(x = year, y = dens.weight.mean), geom = "line", linewidth = 2) +
 # stat_smooth(aes(x = year, y = dens.weight.mean), method = "lm", linewidth = 3) +
  stat_summary(data = ZoDensWQsem.No0_Predict,
               aes(x = year, y = dens.weight.mean), fun = sum, geom = "line", linewidth = 2, color = "pink") +
  theme_bw(base_size=20) + 
 # ylim(0, 2) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
       # panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "right") +
  facet_wrap(~Scen)

zdwm_unshuff = 
ZoFuture.DWM100 %>% #filter(between(simnum_OB, 1, 20)) %>%
  group_by(simnum_OB, year, Scen) %>% 
  summarize(dens.weight.mean = sum(dens.weight.mean, na.rm = T), 
            Temp.spmed = mean(Temp.spmed, na.rm = T), 
            TN.spme = mean(TN.spme, na.rm = T)) %>%
ggplot(data = .) + #%>% filter(between(simnum_OB, 1, 3)) ) +
  stat_summary(aes(x = year, y = dens.weight.mean, color = Scen, group = simnum_OB), geom = "line", linewidth = .5) +
  stat_summary(aes(x = year, y = dens.weight.mean), geom = "line", linewidth = 2) +
 # stat_smooth(aes(x = year, y = dens.weight.mean), method = "lm", linewidth = 3) +
  stat_summary(data = ZoDensWQsem.No0_Predict,
               aes(x = year, y = dens.weight.mean), fun = sum, geom = "line", linewidth = 2, color = "pink") +
  theme_bw(base_size=20) + 
#  ylim(0, 2) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        #panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "") +
  facet_wrap(~Scen)

zdwm_shuff/zdwm_unshuff

```


```{r Visualize all Scenarios}

Area.Summary_Shuff = 
FullBaeFuture.SAVOnly_Shuff %>% 
  group_by(simnum_OB, year, SpCluster, Scen) %>% 
  summarize(across(Area:dens.weight.mean, ~sum(.x, na.rm = T))) %>% 
  group_by(year, Scen, SpCluster) %>% 
  summarize(across(Area:dens.weight.mean, list(mean = mean, min = min, max = max, sd = sd), na.rm = T, .names = "{col}.{fn}")) 

a = 
  ggplot(data = Area.Summary_Shuff, aes(x = year, y = Area.mean)) + 
    geom_ribbon(aes(group = Scen, color = Scen, fill = Scen, x = year, 
                  ymin = Area.min, ymax = Area.max), linewidth = 2, alpha = .7) +
  geom_line(aes(color = Scen)) + 
  stat_smooth(aes(color = Scen), method = "gam", linewidth = 2) +
      stat_summary(data = SAVCommDensWQ_ForPred.with0s %>% filter(SpCluster %in% c("Ruppia", "Zostera", "MixedMeso", "Fresh")), aes(x = year, y = SAVArea), linewidth = 1, fun = sum, geom = "line") +
  facet_grid(SpCluster~Scen, scales = "free_y") + 
    labs(y = "SAV area (Acres)", x = "") +
  theme_bw(base_size=15) + 
  scale_x_continuous(breaks=seq(1980, 2070, 20)) +
 # ylim(25000, 200000) +
 # scale_color_manual(values = scencol) +
 # scale_fill_manual(values = scencol) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")
a

FullBaeFuture.SAVOnly_Shuff %>% 
  group_by(simnum_OB, year, Scen) %>% 
  summarize(across(Area:dens.weight.mean, ~sum(.x, na.rm = T))) %>% 
  group_by(year, Scen) %>% 
  summarize(across(Area:dens.weight.mean, list(mean = mean, min = min, max = max, sd = sd), na.rm = T, .names = "{col}.{fn}")) %>%
  ggplot(data = ., aes(x = year, y = Area.mean)) + 
    geom_ribbon(aes(group = Scen, color = Scen, fill = Scen, x = year, 
                  ymin = Area.min, ymax = Area.max), linewidth = 2, alpha = .7) +
  geom_line(aes(color = Scen)) + 
  stat_smooth(aes(color = Scen), method = "gam", linewidth = 2) +
      stat_summary(data = SAVCommDensWQ_ForPred.with0s %>% filter(SpCluster %in% c("Ruppia", "Zostera", "MixedMeso", "Fresh")), aes(x = year, y = SAVArea), linewidth = 1, fun = sum, geom = "line") + 
  labs(y = "SAV area (Acres)", x = "") +
  theme_bw(base_size=15) + 
  scale_x_continuous(breaks=seq(1980, 2070, 20)) +
 # ylim(25000, 200000) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "") +
  facet_wrap(~Scen)


```





#Shiny APP Stuff
```{r Convert to segments}

#Density Only data here, probably best to use this?
FullBaeFuture.SAVOnly_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/FullBaeFuture.SAVOnly_Shuff.csv")


#FullBaeFuture.ALLDATA100 = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/FullBaeFuture.ALLDATA100.csv")

FullBaeFuture.ALLDATA100_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/FullBaeFuture.ALLDATA100_Shuff.csv")

#SAVCommDensWQ_ForPred.SEG = right_join(SAVCommDensWQ_ForPred.with0s, 
#                                       SegmentConvert %>% rename(STATION = Station), 
#                                       join_by(STATION), multiple = "all") %>% #bring the basins in
#  filter(SpCluster %in% c("Ruppia", "Zostera", "Fresh", "MixedMeso")) %>% #filter out the RuZo and other comms
#  group_by(year, cbpseg, SpCluster) %>%
#  mutate(Area.seg = sum(SAVArea * Pct_stn_area/100), 
#         DWM.seg = sum(dens.weight.mean * Pct_stn_area/100)) %>% 
#  summarise(across(Temp.sumy1med:TN.summe, mean, na.rm = T, .names = "{col}"), 
#            Area.seg = mean(Area.seg), 
#            DWM.seg = mean(DWM.seg)) %>% 
#  select(year, cbpseg, SpCluster, Area.seg, DWM.seg, everything()) 

#vroom_write(SAVCommDensWQ_ForPred.SEG, "/Volumes/savshare2/Current Projects/Predicting-SAV/data/communityDFs/SAVCommDensWQ_ForPred.SEG.csv")


#Lets just use the SAV Area data frame and join in the Env stuff later.
#Shuff Summary of every 100 simulations for every segment and every SpCluster and every Scenario####
AllSims.SAV.SEGMENT_Shuff =  right_join(FullBaeFuture.SAVOnly_Shuff, 
                                   SegmentConvert %>% rename(STATION = Station),
                                   join_by(STATION), multiple = "all") %>%
  group_by(simnum_OB, year, cbpseg, SpCluster, Scen) %>% #summarize across stations
  summarize(Area.seg = sum(Area * Pct_stn_area/100), #in every sim, year, SpClust, Scen.. how much in each seg?
         DWM.seg = sum(dens.weight.mean * Pct_stn_area/100)) %>% #, 
       #  denscomp.max.seg = sum(denscomp.max * Pct_stn_area/100), #calculate denscomp.max per segment per SpClust
       #  Goal.seg = sum(Goal.stn * Pct_stn_area/100)) %>% #just paste the goal per segment here
  mutate(Area.seg.acre = Area.seg * 2.47105, 
         DWM.seg.acre = DWM.seg * 2.47105) #convert to acres 1 hectare = 2.47105 acres

vroom_write(AllSims.SAV.SEGMENT_Shuff, "/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/AllSims.SAV.SEGMENT_Shuff.csv")

 #Build Master Segment for ENV for Shiny app: 
#BaeEnvGrow.SEGMENT_8420 = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/communityDFs/BaeEnvGrow.SEGMENT_8420.csv")

#FullBaeSAV.EnvGrow_8420 = full_join(BaeEnvGrow.SEGMENT_8420, SAVCommDensWQ_ForPred.SEG, multiple = "all") %>% 
#  drop_na(SpCluster) %>% 
#  filter(!SpCluster == "RuZo") %>%
#  mutate(Area.seg.acre = Area.seg * 2.47105, 
#         DWM.seg.acre = DWM.seg * 2.47105) %>% 
#  ungroup() 

#Here is the big bad awesome Perfect final DF####
#Note that, for cross- bay compare of Env Conditions, we use this Growing Season ENV data.
BaeEnvGrow.SEGMENT_2060 = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/communityDFs/BaeEnvGrow.SEGMENT_2060.csv")

#For some reason, when viewed as the points, it doesnt look that patterened 
#BaeEnvGrow.SEGMENT_2060 %>%
  #filter(str_detect(cbpseg, "^MOB")) %>% filter(simnum_OB %in% c(53)) %>%
#  ggplot(data = .) + 
 # geom_line(aes(x = year, y = TN.growme, color = Scen, group = simnum_OB)) +
#  stat_summary(aes(x = year, y = TN.growme, color = Scen), geom = "pointrange", fun.data = "mean_se") +
#  stat_summary(aes(x = year, y = TN.growme, color = Scen), geom = "line", fun.data = "mean_se") 


#CHECK THIS 2020 filter####
#Problem is, this EnvGrow didnt translate well and I need to go back and do it over.
FullBaeSAV.EnvGrow_2160_Shuff = 
  full_join(BaeEnvGrow.SEGMENT_2060 %>% select(-Station),
                                    AllSims.SAV.SEGMENT_Shuff, multiple = "all") %>%
  drop_na(SpCluster) %>% ungroup() #%>% filter(!year == 2020) 

#random subset of simulations dataframe = SomeBaeSAV
#SomeBaeSAV.EnvGrow_2160 = FullBaeSAV.EnvGrow_2160 %>% ungroup() %>%
#  nest(data = Scen:DWM.seg.acre) %>% 
#  slice_sample(n = 40, replace = F) %>% #want more sims? change this number
#                 unnest(cols = c(data))

#random subset of Env dataframe = SomeBaeEnv
#SomeBaeEnvGrow.SEGMENT_2160 = BaeEnvGrow.SEGMENT_2060 %>% ungroup() %>% 
#  select(-Station) %>%
#  nest(data = Scen:TP.growme) %>% 
#  slice_sample(n = 40, replace = F) %>% #want more sims? change this number
#                 unnest(cols = c(data))
  

test = anti_join(FullBaeSAV.EnvGrow_8420, FullBaeSAV.EnvGrow_2160)

#vroom_write(FullBaeSAV.EnvGrow_8420, "/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/FullBaeSAV.EnvGrow_8420.csv")

#write to shiny app too
#vroom_write(FullBaeSAV.EnvGrow_8420, "/Volumes/savshare2/Current Projects/Predicting-SAV/Webpage/shiny/data/FullBaeSAV.EnvGrow_8420.csv")



#vroom_write(FullBaeSAV.EnvGrow_2160, "/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/FullBaeSAV.EnvGrow_2160.csv")
#vroom_write(SomeBaeSAV.EnvGrow_2160, "/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/SomeBaeSAV.EnvGrow_2160.csv")

vroom_write(FullBaeSAV.EnvGrow_2160_Shuff, "/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/FullBaeSAV.EnvGrow_2160_Shuff.csv")

```

```{r Spaghetti Baywide and SpComm Figure}
#FullBaeSAV.EnvGrow_2160 = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/FullBaeSAV.EnvGrow_2160.csv")
AllSims.SAV.SEGMENT_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/AllSims.SAV.SEGMENT_Shuff.csv")
SpaghettiBay.Fig =
  FullBaeSAV.EnvGrow_2160_Shuff %>% 
  group_by(simnum_OB, Scen, year) %>% 
    summarize(across(Area.seg:DWM.seg.acre, ~sum(.x, na.rm = T)), 
            across(Temp.growme:TP.growme, ~mean(.x, na.rm = T))) %>%
ggplot(data = .) + 
  stat_summary(data = FullBaeSAV.EnvGrow_8420, 
               aes(x = year, y = Area.seg.acre), 
               fun = "sum", geom = "line",  
               linewidth = 3) +
    geom_line(aes(x = year, y = Area.seg.acre, group = simnum_OB), size = .2, alpha = .2) +
 # stat_smooth(aes(x = year, y = Area.seg.acre, color = Scen), 
 #               method = "lm",  
 #              linewidth = 3) +
  geom_hline(yintercept = 185000, color = "blue", linewidth = 12) +
  geom_text(aes(x = 2020, y = 185000, label = "Baywide SAV Goal (184,889 A)"), stat = "unique", size = 3, color = "antiquewhite") +
  labs(y = "SAV area (Acres)", x = "") +
  ylim(0, 200000) +
  theme_bw(base_size=20) + 
  scale_x_continuous(breaks=seq(1980, 2070, 20)) +
  scale_color_manual(values = scencol) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "") +
  facet_wrap(~Scen)

SpaghettiBay.Fig
ggsave("/Volumes/savshare2/Current Projects/Predicting-SAV/MH_Predicting-SAV/SpaghettiBay.Fig.png")

SpaghettiTemp.Fig =
  FullBaeSAV.EnvGrow_2160_Shuff %>% 
  group_by(simnum_OB, Scen, year) %>% 
    summarize(across(Area.seg:DWM.seg.acre, ~sum(.x, na.rm = T)), 
            across(Temp.growme:TP.growme, ~mean(.x, na.rm = T))) %>%
ggplot(data = .) + 
  stat_summary(data = FullBaeSAV.EnvGrow_8420, 
               aes(x = year, y = Temp.growme), 
               fun.data = "mean_se", geom = "line",  
               linewidth = 3) +
    geom_line(aes(x = year, y = Temp.growme, group = simnum_OB), size = .2, alpha = .2) +
 # stat_smooth(aes(x = year, y = Temp.growme, color = Scen), 
 #               method = "lm",  
 #              linewidth = 3) +
  labs(y = "Temperature (C)", x = "") +
  theme_bw(base_size=24) + 
  scale_x_continuous(breaks=seq(1980, 2070, 10)) +
  scale_color_manual(values = scencol) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")# + 
  #facet_wrap(~Scen)

SpaghettiTemp.Fig
ggsave("/Volumes/savshare2/Current Projects/Predicting-SAV/MH_Predicting-SAV/SpaghettiTemp.Fig.png")

SpaghettiTN.Fig =
  FullBaeSAV.EnvGrow_2160_Shuff %>% 
  group_by(simnum_OB, Scen, year) %>% 
    summarize(across(Area.seg:DWM.seg.acre, ~sum(.x, na.rm = T)), 
            across(Temp.growme:TP.growme, ~mean(.x, na.rm = T))) %>%
ggplot(data = .) + 
  stat_summary(data = FullBaeSAV.EnvGrow_8420, 
               aes(x = year, y = TN.growme), 
               fun.data = "mean_se", geom = "line",  
               linewidth = 3) +
    geom_line(aes(x = year, y = TN.growme, group = simnum_OB, color = Scen), size = .2, alpha = .2) +
  stat_smooth(aes(x = year, y = TN.growme, color = Scen), 
                method = "lm",  
               linewidth = 3) +
  labs(y = "TN", x = "") +
  theme_bw(base_size=14) + 
  scale_x_continuous(breaks=seq(1980, 2070, 10)) +
 # scale_color_manual(values = scencol) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "right") + 
  facet_grid(~Scen)

SpaghettiTN.Fig

SpaghettiTP.Fig =
  FullBaeSAV.EnvGrow_2160_Shuff %>% 
  group_by(simnum_OB, Scen, year) %>% 
    summarize(across(Area.seg:DWM.seg.acre, ~sum(.x, na.rm = T)), 
            across(Temp.growme:TP.growme, ~mean(.x, na.rm = T))) %>%
ggplot(data = .) + 
  stat_summary(data = FullBaeSAV.EnvGrow_8420, 
               aes(x = year, y = TP.growme), 
               fun.data = "mean_se", geom = "line",  
               linewidth = 3) +
    geom_line(aes(x = year, y = TP.growme, group = simnum_OB, color = Scen), size = .2, alpha = .2) +
  stat_smooth(aes(x = year, y = TP.growme, color = Scen), 
                method = "lm",  
               linewidth = 3) +
  labs(y = "TP", x = "") +
  theme_bw(base_size=14) + 
  scale_x_continuous(breaks=seq(1980, 2070, 10)) +
  scale_color_manual(values = scencol) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "right")

SpaghettiTP.Fig

SpaghettiNutrients = SpaghettiTN.Fig / SpaghettiTP.Fig

ggsave("/Volumes/savshare2/Current Projects/Predicting-SAV/MH_Predicting-SAV/SpaghettiTN.Fig.png")
ggsave("/Volumes/savshare2/Current Projects/Predicting-SAV/DW_Predicting-SAV/shiny/testshiny/images/SpaghettiNutrients.png")


SpaghettiSpClust.Fig =
  AllSims.SAV.SEGMENT_Shuff %>% drop_na(SpCluster) %>%
  group_by(simnum_OB, Scen, year, SpCluster) %>% 
    summarize(across(Area.seg:DWM.seg.acre, ~sum(.x, na.rm = T))) %>%
ggplot(data = .) + 
  stat_summary(data = FullBaeSAV.EnvGrow_8420, 
               aes(x = year, y = Area.seg.acre, group = SpCluster), 
               fun = "sum", geom = "line",  
               linewidth = 3) +
    geom_line(aes(x = year, y = Area.seg.acre, group = simnum_OB), linewidth = .2, alpha = .2) +
  stat_smooth(aes(x = year, y = Area.seg.acre, color = Scen), 
                method = "lm",  
               linewidth = 3) +
  labs(y = "SAV area (Acres)", x = "") +
  theme_bw(base_size=14) + 
  scale_x_continuous(breaks=seq(1980, 2070, 10)) +
 # scale_color_manual(values = scencol) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "") +
  facet_grid(SpCluster~Scen, scales = "free_y", labeller = 
               labeller(SpCluster = c("Fresh" = "Tidal Fresh/Oligohaline",
                                      "MixedMeso" = "Mixed Mesohaline",
                                      "Ruppia" = "Ruppia monoculture", 
                                      "Zostera" = "Zostera monoculture")))

SpaghettiSpClust.Fig

ggsave("/Volumes/savshare2/Current Projects/Predicting-SAV/MH_Predicting-SAV/SpaghettiSpClust.Fig.png")



```


#RUN THIS CHUNK FOR SHINY FIGS
```{r FSimSum.. 95% of Shuff Simulations DF by Seg, Comm, Bay}
FullBaeSAV.EnvGrow_8420 = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/FullBaeSAV.EnvGrow_8420.csv")

FullBaeSAV.EnvGrow_2160_Shuff = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/FullBaeSAV.EnvGrow_2160_Shuff.csv") %>% 
    filter(!Scen %in% c("Connowingo", "No CC No Action"))
#SomeBae = 40 random sims
SomeBaeSAV.EnvGrow_2160 = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/SomeBaeSAV.EnvGrow_2160.csv")

#Full Predictions (100 sims) summarized by area for each Community (SpCluster)
#first, sum up each station within each of the segments
FSimSumSp_All = 
  FullBaeSAV.EnvGrow_2160_Shuff %>% 
  group_by(simnum_OB, Scen, SpCluster, year) %>% 
  summarize(across(Area.seg:DWM.seg.acre, ~sum(.x, na.rm = T)), 
            across(Temp.growme:TP.growme, ~mean(.x, na.rm = T)))
FSimSumSp_95per = 
  FSimSumSp_All %>%
  group_by(Scen, year, SpCluster) %>% 
  slice_max(order_by = Area.seg, n = 5) 
FSimSumSp_5per = 
  FSimSumSp_All %>%
  group_by(Scen, year, SpCluster) %>% 
  slice_min(order_by = Area.seg, n = 5) #NOTE: n = 5 because total sims = 100. 

#final DF for the envelope figs, with the top 5% and botom 5% removed
FSimSumSp_Trimmed = anti_join(FSimSumSp_All, FSimSumSp_5per) %>% anti_join(FSimSumSp_95per) %>%
  group_by(Scen, SpCluster, year) %>%
  summarize(across(Area.seg:DWM.seg.acre, list(median = median, max = max, min = min, mean = mean)), 
            across(Temp.growme: TP.growme, list(median = median, max = max, min = min, mean = mean))) %>% ungroup()

#Segment Envelope Figure
FSimSumSeg_All = 
  FullBaeSAV.EnvGrow_2160_Shuff %>% 
  group_by(simnum_OB, Scen, cbpseg, year) %>% 
  summarize(across(Area.seg:DWM.seg.acre, ~sum(.x, na.rm = T)), 
            across(Temp.growme:TP.growme, ~mean(.x, na.rm = T)))
FSimSumSeg_95per = 
  FSimSumSeg_All %>%
  group_by(Scen, year, cbpseg) %>% 
  slice_max(order_by = Area.seg, n = 5) 
FSimSumSeg_5per = 
  FSimSumSeg_All %>%
  group_by(Scen, year, cbpseg) %>% 
  slice_min(order_by = Area.seg, n = 5) 

#Same as above but lets add the segment goals in there for compares
FSimSumSeg_Trimmed = anti_join(FSimSumSeg_All, FSimSumSeg_5per) %>% anti_join(FSimSumSeg_95per) %>% 
  full_join(SegGoals) %>% 
  mutate(PropGoal = Area.seg.acre/Goal, #Calculate the proportion of the goal met, where 1 = goal met exactly
         GoalYN = case_when(Area.seg.acre >= Goal ~ 1, 
                            Area.seg.acre < Goal ~ 0)) %>% 
  group_by(Scen, year, cbpseg) %>%
  summarize(across(Area.seg:DWM.seg.acre, list(median = median, max = max, min = min, mean = mean)), 
            across(Temp.growme: TP.growme, list(median = median, max = max, min = min, mean = mean)),
            Goal.seg = mean(Goal), PropGoal.mean = mean(PropGoal, na.rm = T), GoalYN100 = sum(GoalYN)/100) %>% 
  ungroup() 

#Baywide Summary
FSimSum_All = 
  FullBaeSAV.EnvGrow_2160_Shuff %>% 
  group_by(simnum_OB, Scen, year) %>% 
  summarize(across(Area.seg:DWM.seg.acre, ~sum(.x, na.rm = T)), 
            across(Temp.growme:TP.growme, ~mean(.x, na.rm = T)))
FSimSum_95per = 
  FSimSum_All %>%
  group_by(Scen, year) %>% 
  slice_max(order_by = Area.seg, n = 5) 
FSimSum_5per = 
  FSimSum_All %>%
  group_by(Scen, year) %>% 
  slice_min(order_by = Area.seg, n = 5) 

FSimSum_Trimmed = anti_join(FSimSum_All, FSimSum_5per) %>% anti_join(FSimSum_95per) %>%
  group_by(Scen, year) %>%
  summarize(across(Area.seg:DWM.seg.acre, list(median = median, max = max, min = min, mean = mean)), 
            across(Temp.growme: TP.growme, list(median = median, max = max, min = min, mean = mean)))  %>% 
  mutate(PropGoal.acre = Area.seg.acre_median/184889) %>%
  ungroup() 

#ALERT! Filtering out the other Scenarios for now but not forever!!!####
FSimSumSp_Trimmed1 = FSimSumSp_Trimmed %>% filter(Scen %in% c("No Further Action", "Nutrient Reduction"))
FSimSumSeg_Trimmed1 = FSimSumSeg_Trimmed %>% filter(Scen %in% c("No Further Action", "Nutrient Reduction"))
FSimSum_Trimmed1 = FSimSum_Trimmed %>% filter(Scen %in% c("No Further Action", "Nutrient Reduction"))

vroom_write(FSimSumSp_Trimmed1, "/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/FSimSumSp_Trimmed.csv")
vroom_write(FSimSumSeg_Trimmed1, "/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/FSimSumSeg_Trimmed.csv")
vroom_write(FSimSum_Trimmed1, "/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/FSimSum_Trimmed.csv")

#write to the shiny fodler
vroom_write(FSimSumSp_Trimmed1, "/Volumes/savshare2/Current Projects/Predicting-SAV/Webpage/shiny/data/FSimSumSp_Trimmed.csv")
vroom_write(FSimSumSeg_Trimmed1, "/Volumes/savshare2/Current Projects/Predicting-SAV/Webpage/shiny/data/FSimSumSeg_Trimmed.csv")
vroom_write(FSimSum_Trimmed1, "/Volumes/savshare2/Current Projects/Predicting-SAV/Webpage/shiny/data/FSimSum_Trimmed.csv")
  
PastSAVSp_Total = FullBaeSAV.EnvGrow_8420 %>% group_by(year, SpCluster) %>% 
  summarize(across(Area.seg.acre:DWM.seg.acre, ~sum(.x, na.rm = T)), 
            across(Temp.growme:TP.growme, ~mean(.x, na.rm = T))) %>% ungroup()
PastSAVSeg_Total = FullBaeSAV.EnvGrow_8420 %>% group_by(year, cbpseg) %>% 
  summarize(across(Area.seg.acre:DWM.seg.acre, ~sum(.x, na.rm = T)), 
            across(Temp.growme:TP.growme, ~mean(.x, na.rm = T))) %>% ungroup()
PastSAV_Total = FullBaeSAV.EnvGrow_8420 %>% group_by(year) %>% 
  summarize(across(Area.seg.acre:DWM.seg.acre, ~sum(.x, na.rm = T)), 
            across(Temp.growme:TP.growme, ~mean(.x, na.rm = T))) %>% ungroup()

```


```{r Final Report Figures}

Community_Area.Past.Fig =
  SAVCommDensWQ_ForPred.with0s %>% 
  group_by(year, SpCluster) %>%
  summarize(SAVArea = sum(SAVArea)*2.47105) %>% 
  mutate(SpCluster = case_when(SpCluster == "Fresh" ~ "Tidal Fresh/Oligohaline", 
                               SpCluster == "MixedMeso" ~ "Mixed Mesohaline", 
                               SpCluster == "Zostera" ~ "Zostera monoculture", 
                               SpCluster == "Ruppia" ~ "Ruppia monoculture", 
                               SpCluster == "RuZo" ~ "Ruppia-Zostera Mix")) %>% 
  filter(!SpCluster == "Ruppia-Zostera Mix") %>%
ggplot(data = .)+ #%>% filter(SpCluster %in% c("Zostera", "Fresh", "Ruppia", "MixedMeso"))) + 
  stat_summary(aes(x = year, y = SAVArea, color = SpCluster), 
               fun = "sum", geom = "line",  
               size = 3) +
  labs(y = "Total SAV area (Acres)", x = "") +
  theme_bw(base_size=38) + 
  scale_x_continuous(breaks=seq(1980, 2030, 10)) +
  scale_color_manual(values = c("darkorchid", "blue4", "darkgoldenrod2", "darkolivegreen4")) +
  theme(plot.margin = unit(c(1.3, 2, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "right", legend.title = element_blank(), legend.text = element_text(size = 22))

Community_Area.Past.Fig

ggsave("/Volumes/savshare2/Current Projects/Predicting-SAV/MH_Predicting-SAV/Community_Area.Past.Fig.png")

ggsave("/Volumes/savshare2/Current Projects/Predicting-SAV/DW_Predicting-SAV/shiny/testshiny/images/Community_Area.Past.Fig.png")

#lol what the fuck am i lookin at here bro
FutureTemp.Fig =
  FullBaeSAV.EnvGrow_2160_Shuff %>% 
  group_by(simnum_OB, Scen, year) %>% 
  summarize(Area = sum(Area.seg.acre, na.rm = T), 
            across(Temp.growme:TP.growme, ~mean(.x, na.rm = T))) %>%
ggplot(data = ., aes(x = year, y = Temp.growme)) + #filter only SEG of interest REACTIVE HERE!!
  stat_summary(fun.data = mean_se, geom = "line", size = .5, alpha = .4) +
#  stat_smooth(aes(color = Scen), 
#               method = "gam", size = 2) +
#  geom_labelsmooth(aes(x = year, y = Temp.growme, label = Scen, color = Scen), 
#                   method = "gam", boxlinewidth = 0, size = 3, alpha = .5) +
  labs(y = "Temperature (C)", x = "year") +
  theme_bw(base_size=16) + 
  scale_x_continuous(breaks=seq(1980, 2070, 10)) +
  #scale_color_manual(values = scencol) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "") + 
  facet_wrap(~Scen)
FutureTemp.Fig

FullBaeSAV.EnvGrow_8420 = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/FullBaeSAV.EnvGrow_8420.csv")
#load in future data. this is 40 random sims selected from FullBaeSAV.EnvGrow_2160 (chunk 28)
SomeBaeSAV.EnvGrow_2160 = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/SomeBaeSAV.EnvGrow_2160.csv")
FullBaeSAV.EnvGrow_2160 = vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Multiversal Futures ONEBAY/FullBaeSAV.EnvGrow_2160.csv")
#Bay totals by Scenario
Bay_95per.Fig = 
  ggplot(data = FSimSum_Trimmed) + 
  geom_ribbon(aes(group = Scen, color = Scen, fill = Scen, x = year, 
                  ymin = Area.seg.acre_min, ymax = Area.seg.acre_max), linewidth = 2,  alpha = .7) +
  stat_smooth(aes(x = year, y = Area.seg.acre_median, color = Scen), linewidth = 2,
              method = "gam") +
  stat_summary(data = PastSAV_Total, aes(x = year, y = Area.seg.acre), linewidth = 1,
               fun.data = "mean_se", geom = "line") +
  geom_labelsmooth(aes(x = year, y = Area.seg.acre_median, label = Scen, color = Scen), 
                   method = "lm", boxlinewidth = 0, size = 4.5, alpha = .8) +
  geom_hline(yintercept = 185000, color = "blue", linewidth = 12) +
  geom_text(aes(x = 2020, y = 185000, label = "Baywide SAV Goal (184,889 A)"), stat = "unique", size = 9, color = "antiquewhite") +
  labs(y = "SAV area (Acres)", x = "") +
  theme_bw(base_size=30) + 
  scale_x_continuous(breaks=seq(1980, 2070, 20)) +
  ylim(25000, 200000) +
  scale_color_manual(values = scencol) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")
Bay_95per.Fig

FullBaeSAV.EnvGrow_2160 %>% drop_na() %>%
  group_by(simnum_OB, Scen, year) %>% 
  summarize(Area = sum(Area.seg.acre, na.rm = T)) %>% 
  ggplot(data = ., aes(x = year, y = Area)) + 
  geom_line(aes(group = simnum_OB), alpha = .3) +
  stat_smooth(aes(x = year, y = Area, color = Scen), linewidth = 2,
              method = "gam") +
  stat_summary(data = FullBaeSAV.EnvGrow_8420 %>% group_by(year) %>% summarize(Area = sum(Area.seg)*2.47105),
               aes(x = year, y = Area), linewidth = 1,
               fun = "sum", geom = "line") +
  geom_hline(yintercept = 185000, color = "blue", linewidth = 12) +
  geom_text(aes(x = 2020, y = 185000, label = "Baywide SAV Goal (184,889 A)"), stat = "unique", size = 6, color = "antiquewhite") +
  labs(y = "SAV area (Acres)", x = "") +
  theme_bw(base_size=30) + 
  scale_x_continuous(breaks=seq(1980, 2070, 20)) +
  ylim(25000, 200000) +
  scale_color_manual(values = scencol) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "") +
  facet_wrap(~Scen)

SpCluster_95per.Fig = 
  ggplot(data = FSimSumSp_Trimmed) + 
  geom_ribbon(aes(group = Scen, color = Scen, fill = Scen, x = year, 
                  ymin = Area.seg.acre_min, ymax = Area.seg.acre_max), linewidth = 2, alpha = .7) +
  stat_smooth(aes(x = year, y = Area.seg.acre_median, color = Scen), linewidth = 2,
              method = "lm") +
  stat_summary(data = PastSAVSp_Total, aes(x = year, y = Area.seg.acre), linewidth = 1,
               fun.data = "mean_se", geom = "line") +
 # geom_labelsmooth(aes(x = year, y = Area.seg.acre_median, label = Scen, color = Scen), 
 #                  method = "lm", boxlinewidth = 0, size = 6, alpha = .6) + 
  labs(y = "SAV area (Acres)", x = "") +
  theme_bw(base_size=38) + 
  scale_x_continuous(breaks=seq(1980, 2060, 20)) +
  scale_color_manual(values = scencol) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "") +
  facet_wrap(~SpCluster, scales = "free_y", labeller = 
               labeller(SpCluster = c("Fresh" = "Tidal Fresh/Oligohaline",
                                      "MixedMeso" = "Mixed Mesohaline",
                                      "Ruppia" = "Ruppia monoculture", 
                                      "Zostera" = "Zostera monoculture")))
SpCluster_95per.Fig




```


```{r figure colors}
#colors for SpClusters, fresh, ruppia, zostera: 
commcol = c("darkgoldenrod2", "darkorchid", "blue4", "darkolivegreen4" )

#colors for Scenarios: 
scencol = c("brown1", "chartreuse4", "lightblue")



```



```{r _Trimmed df figure lookin}
SpClusterFIG = 
ggplot(data = FSimSumSp_Trimmed) + 
  geom_ribbon(aes(group = Scen, color = Scen, fill = Scen, x = year, 
                  ymin = Area.seg.acre_min, ymax = Area.seg.acre_max),  alpha = .7) +
  stat_smooth(aes(x = year, y = Area.seg.acre_mean, color = Scen), linewidth = 2,
               method = "gam") +
  stat_summary(data = PastSAVSp_Total, aes(x = year, y = Area.seg.acre), linewidth = 1,
               fun.data = "mean_se", geom = "line") +
  labs(y = "SAV area (HA)", x = "") +
  theme_bw(base_size=20) + 
  scale_x_continuous(breaks=seq(1980, 2060, 20)) +
  scale_color_manual(values = scencol) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "") +
  facet_wrap(~SpCluster, scales = "free_y", labeller = labeller(SpCluster = 
    c("Fresh" = "Tidal Fresh/Oligohaline",
      "MixedMeso" = "Mixed Mesohaline",
      "Ruppia" = "Ruppia monoculture", 
      "Zostera" = "Zostera monoculture")))

SpClusterFIG
#ggsave("/Volumes/savshare2/Current Projects/Predicting-SAV/MH_Predicting-SAV/SpClusterRibbonFig.png")



Scen_95per.Fig = 
ggplot(data = FSimSum_Trimmed) + 
  geom_ribbon(aes(group = Scen, color = Scen, fill = Scen, x = year, 
                  ymin = Area.min, ymax = Area.max),  alpha = .7) +
  stat_smooth(aes(x = year, y = Area.med, color = Scen), linewidth = 2,
               method = "gam") +
  stat_summary(data = PastSAV_Total, aes(x = year, y = Area.seg), linewidth = 1,
               fun.data = "mean_se", geom = "line") +
    geom_text(aes(x = 2020, y = 69000, label = "Baywide SAV Goal (74,000 HA)"), stat = "unique", size = 8, color = "blue") +
  geom_hline(yintercept = 74000) +
  labs(y = "SAV area (HA)", x = "") +
  theme_bw(base_size=30) + 
  scale_x_continuous(breaks=seq(1980, 2070, 10)) +
  scale_color_manual(values = scencol) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")

Scen_95per.Fig
#ggsave("/Volumes/savshare2/Current Projects/Predicting-SAV/MH_Predicting-SAV/ScenarioRibbonFig.png")


Seg_95per.ReactiveFig = 
  FSimSumSeg_Trimmed %>% 
  filter(cbpseg == "PAXTF") %>%
  ggplot(data = .) + #Segment is the reactive variable
  geom_ribbon(aes(group = Scen, color = Scen, fill = Scen, x = year, 
                  ymin = Area.seg.acre_min, ymax = Area.seg.acre_max),  alpha = .7) +
  stat_smooth(aes(x = year, y = Area.seg.acre_mean, color = Scen), linewidth = 2,
              method = "gam") +
    stat_summary(aes(x = year, y = Area.seg.acre_mean, color = Scen), linewidth = 2,
              geom = "line") +
  stat_summary(data = PastSAVSeg_Total %>% filter(cbpseg == "PAXTF"),
               aes(x = year, y = Area.seg.acre), linewidth = 1,
               fun.data = "mean_se", geom = "line") + 
  geom_labelsmooth(aes(x = year, y = Area.seg.acre_median, label = Scen, color = Scen), 
                   method = "gam", boxlinewidth = 0, size = 3.5, alpha = .6) + 
  geom_hline(aes(yintercept = Goal.seg, group = cbpseg), color = "deeppink2", linewidth = 10) +
  geom_text(aes(x = 2020, y = Goal.seg, label = "Segment Restoration Goal (Acres)"), stat = "unique", size = 6, color = "aliceblue") +
  labs(y = "SAV area (A)", x = "") +
  theme_bw(base_size=30) + 
  scale_x_continuous(breaks=seq(1980, 2070, 10)) +
  scale_color_manual(values = scencol) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")
Seg_95per.ReactiveFig
```



```{r}

SAVTemp.Fig =
  FullBaeSAV.EnvGrow_2160 %>% 
  group_by(simnum_OB, Scen, year, SpCluster) %>% 
  summarize(Area = sum(Area.seg.acre, na.rm = T), 
            across(Temp.growme:TP.growme, ~mean(.x, na.rm = T))) %>%
ggplot(data = ., aes(x = Temp.growme, y = Area)) + #filter only SEG of interest REACTIVE HERE!!
  stat_summary(aes(color = SpCluster), 
               fun.data = mean_se, geom = "pointrange", size = .5, alpha = .4) +
  stat_smooth(aes(color = Scen), 
               method = "gam", size = 2) +
#  geom_labelsmooth(aes(x = year, y = Temp.growme, label = Scen, color = Scen), 
#                   method = "gam", boxlinewidth = 0, size = 3, alpha = .5) +
  labs(x = "Temperature (C)", y = "SAV Area") +
  theme_bw(base_size=16) + 
  scale_x_continuous(breaks=seq(1980, 2070, 10)) +
  #scale_color_manual(values = scencol) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "") + 
  facet_wrap(~Scen)
SAVTemp.Fig

```



```{r sim sum sexy}
#in the same vein as above, lets grab a selection of the sexiest and ugliest scenarios

SimSum_Sexy = 
  FullBaeSAV.EnvGrow_2160_Shuff %>% 
  group_by(simnum_OB, Scen, year) %>% 
  summarize(Area.seg = sum(Area.seg.acre, na.rm = T)) %>%
  group_by(Scen, year) %>% 
  slice_max(order_by = Area.seg, n = 10) 
SimSum_Ugly = 
  FullBaeSAV.EnvGrow_2160_Shuff %>% 
  group_by(simnum_OB, Scen, year) %>% 
  summarize(Area.seg = sum(Area.seg.acre, na.rm = T)) %>%
  group_by(Scen, year) %>% 
  slice_min(order_by = Area.seg, n = 10) 
SimSum_Rando = 
  FullBaeSAV.EnvGrow_2160 %>% 
  group_by(simnum_OB, Scen, year) %>% 
  summarize(Area.seg = sum(Area.seg.acre, na.rm = T)) %>%
  group_by(Scen, year) %>% 
  slice_sample(n = 10) 

SimSum_Med = 
  FullBaeSAV.EnvGrow_2160 %>% 
  group_by(Scen, year) %>% 
  summarize(Area.med = sum(Area.seg, na.rm = T)) 

42, 56, 4, 74, 92, 56 \ 16, 50, 96, 71

SimSum_Sample = full_join(SimSum_Sexy, SimSum_Ugly) %>% full_join(SimSum_Rando) %>%
  group_by(Scen, year) %>%
  summarize(Area.seg = mean(Area.seg), Area.max = max(Area.seg), Area.med = median(Area.seg), Area.min = min(Area.seg))
  
PastSAV_Total = FullBaeSAV.EnvGrow_8420 %>% group_by(year) %>% 
  summarize(Area.seg = sum(Area.seg, na.rm = T))
```



```{r}

ThatSoRando_ByScen.fig =
ggplot(data = SimSum_Sample) + 
    stat_summary(aes(x = year, y = Area.med), 
               fun.data = "mean_se", geom = "line",  
               size = 4) +
      stat_summary(data = PastSAV_Total, aes(x = year, y = Area.seg), 
               fun.data = "mean_se", geom = "line",  
               size = 4) +
  geom_line(aes(x = year, y = Area.med, group = simnum_OB), size = .4, alpha = .3) +
  geom_ribbon(aes(color = Scen, fill = Scen, x = year, 
                  ymin = Area.min, ymax = Area.max),  alpha = .7) +
  geom_smooth(aes(x = year, y = Area.med), method = "gam", se = TRUE) +
  geom_text(aes(x = 2020, y = 72000, label = "Baywide SAV Goal (74,000 HA)"), stat = "unique", size = 8, color = "blue") +
  geom_hline(yintercept = 74000) +
  labs(y = "Total SAV area (HA)", x = "") +
  theme_bw(base_size=24) + 
  scale_x_continuous(breaks=seq(1980, 2070, 10)) +
  scale_color_manual(values = scencol) +
  theme(plot.margin = unit(c(1.3, 2, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "") +
  facet_wrap(~Scen)
ThatSoRando_ByScen.fig

ThatSoRando_ByScen.fig = 
ggplot(data = SimSum_Sample) + 
  geom_ribbon(aes(group = Scen, color = Scen, fill = Scen, x = year, 
                  ymin = Area.min, ymax = Area.max),  alpha = .7) +
  stat_smooth(aes(x = year, y = Area.med, color = Scen), linewidth = 2,
               method = "gam") +
  stat_summary(data = PastSAV_Total, aes(x = year, y = Area.seg), linewidth = 1,
               fun.data = "mean_se", geom = "line") +
    geom_text(aes(x = 2020, y = 69000, label = "Baywide SAV Goal (74,000 HA)"), stat = "unique", size = 8, color = "blue") +
  geom_hline(yintercept = 74000) +
  labs(y = "SAV area (HA)", x = "") +
  theme_bw(base_size=30) + 
  scale_x_continuous(breaks=seq(1980, 2070, 10)) +
  scale_color_manual(values = scencol) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")
ThatSoRando_ByScen.fig


```





```{r other summary DFs of interest like Basin or Community}
seg_info = read_excel("/Volumes/savshare2/Current Projects/Predicting-SAV/data/Stations_byBasinGroup.xlsx", col_names = T, skip = 1)
  
Basins = seg_info %>% select(station, latitude, longitude, BasinSummaryGroup) %>%
  rename(STATION = station, BASIN = BasinSummaryGroup)



BasinFullBae = full_join(FullBaeFuture.ALLDATA100_Shuff, Basins) %>% 
  drop_na(BASIN) %>%
  mutate(BASIN = case_when(BASIN == "VA MAIN" ~ "VA Mainstem", 
                           BASIN == "MD MAIN" ~ "MD Mainstem", 
                           BASIN == "LOWER ES" ~ "Lower East Shore",
                           BASIN == "MD UPPER ES" ~ "MD East & West Shore", 
                           BASIN == "MD UPPER WS" ~ "MD East & West Shore",
                           BASIN == "MD LOWER WS" ~ "MD East & West Shore", 
                           BASIN == "PATAPSCO-BACK" ~ "MD East & West Shore", 
                           BASIN == "PATUXENT" ~ "Potomac",
                           BASIN == "CHOPTANK" ~ "Choptank",
                           BASIN == "RAPPAHANNOCK" ~ "Rappahannock",
                           BASIN == "POTOMAC" ~ "Potomac",
                           BASIN == "YORK" ~ "York & James", 
                           BASIN == "JAMES" ~ "York & James",
                           T ~ BASIN)) %>%
  group_by(simnum_OB, year, Scen, BASIN) %>% #CHANGE THIS AS NECESSARY!! By Basin or segment Probably best
  summarize(Area = sum(Area, na.rm = T), #Area.max = max(Area), Area.min = min(Area),
            dens.weight.mean = sum(dens.weight.mean, na.rm = T)) %>% 
  drop_na()

allcommbasin_past.df = SAVCommDensWQ_ForPred.with0s %>% 
  left_join(Basins, by = c("STATION")) %>%
    drop_na(BASIN) %>%
  mutate(BASIN = case_when(BASIN == "VA MAIN" ~ "VA Mainstem", 
                           BASIN == "MD MAIN" ~ "MD Mainstem", 
                           BASIN == "LOWER ES" ~ "Lower East Shore",
                           BASIN == "MD UPPER ES" ~ "MD East & West Shore", 
                           BASIN == "MD UPPER WS" ~ "MD East & West Shore",
                           BASIN == "MD LOWER WS" ~ "MD East & West Shore", 
                           BASIN == "PATAPSCO-BACK" ~ "MD East & West Shore", 
                           BASIN == "PATUXENT" ~ "Potomac",
                           BASIN == "CHOPTANK" ~ "Choptank",
                           BASIN == "RAPPAHANNOCK" ~ "Rappahannock",
                           BASIN == "POTOMAC" ~ "Potomac",
                           BASIN == "YORK" ~ "York & James", 
                           BASIN == "JAMES" ~ "York & James",
                           T ~ BASIN)) %>%
  group_by(BASIN, year) %>%
  summarize(DWM.total = sum(dens.weight.mean, na.rm = T), 
            Area = sum(SAVArea, na.rm = T)) %>% ungroup()




```



```{r Basin from FullBae Try me again later}

SAVEnvGrow.BASIN =  full_join(FullBaeSAV.EnvGrow_2160, Basins, by = "cbpseg") %>%
  drop_na(BASIN) %>%
  mutate(BASIN = case_when(BASIN == "VA MAIN" ~ "VA Mainstem", 
                           BASIN == "MD MAIN" ~ "MD Mainstem", 
                           BASIN == "LOWER ES" ~ "Lower East Shore",
                           BASIN == "MD UPPER ES" ~ "MD East & West Shore", 
                           BASIN == "MD UPPER WS" ~ "MD East & West Shore",
                           BASIN == "MD LOWER WS" ~ "MD East & West Shore", 
                           BASIN == "PATAPSCO-BACK" ~ "MD East & West Shore", 
                           BASIN == "PATUXENT" ~ "Potomac",
                           BASIN == "CHOPTANK" ~ "Choptank",
                           BASIN == "RAPPAHANNOCK" ~ "Rappahannock",
                           BASIN == "POTOMAC" ~ "Potomac",
                           BASIN == "YORK" ~ "York & James", 
                           BASIN == "JAMES" ~ "York & James",
                           T ~ BASIN)) %>%
  group_by(simnum_OB, year, Scen, waterbody) %>% #CHANGE THIS AS NECESSARY!! By Basin or segment Probably best
  summarize(Area.seg = sum(Area.seg, na.rm = T), #Area.max = max(Area), Area.min = min(Area),
            DWM.seg = sum(DWM.seg, na.rm = T), 
            TN.growme = mean(TN.growme, na.rm = T), 
            Temp.growme = mean(Temp.growme, na.rm = T))

PastSAVEnvGrow.BASIN =  full_join(FullBaeSAV.EnvGrow_8420, Basins, by = "cbpseg") %>%
  drop_na(BASIN) %>%
  mutate(BASIN = case_when(BASIN == "VA MAIN" ~ "VA Mainstem", 
                           BASIN == "MD MAIN" ~ "MD Mainstem", 
                           BASIN == "LOWER ES" ~ "Lower East Shore",
                           BASIN == "MD UPPER ES" ~ "MD East & West Shore", 
                           BASIN == "MD UPPER WS" ~ "MD East & West Shore",
                           BASIN == "MD LOWER WS" ~ "MD East & West Shore", 
                           BASIN == "PATAPSCO-BACK" ~ "MD East & West Shore", 
                           BASIN == "PATUXENT" ~ "Potomac",
                           BASIN == "CHOPTANK" ~ "Choptank",
                           BASIN == "RAPPAHANNOCK" ~ "Rappahannock",
                           BASIN == "POTOMAC" ~ "Potomac",
                           BASIN == "YORK" ~ "York & James", 
                           BASIN == "JAMES" ~ "York & James",
                           T ~ BASIN)) %>%
  group_by(year, waterbody) %>% #CHANGE THIS AS NECESSARY!! By Basin or segment Probably best
  summarize(Area.seg = sum(Area.seg, na.rm = T), #Area.max = max(Area), Area.min = min(Area),
            DWM.seg = sum(DWM.seg, na.rm = T), 
            TN.growme = mean(TN.growme, na.rm = T), 
            Temp.growme = mean(Temp.growme, na.rm = T))

BasinAreaRandoSim.Fig =
  ggplot(data = SAVEnvGrow.BASIN %>% 
           group_by(simnum_OB, Scen, year, waterbody) %>% 
           summarize(Area.seg = sum(Area.seg, na.rm = T)) %>% 
           ungroup()) + #%>% 
          # filter(cbpseg == "TANMH1")) + #REACTIVE HERE!!
  stat_summary(data = . %>% 
                 nest(data = Scen:Area.seg) %>% 
                 slice_sample(n = 1, replace = F) %>% #want more sims? change this number
                 unnest(cols = c(data)) , 
               aes(x = year, y = Area.seg, color = Scen), linewidth = 1, 
               fun.data = mean_se, geom = "line") +
  stat_summary(aes(x = year, y = Area.seg, color = Scen), 
               fun.data = mean_se, geom = "line", linewidth = 2.5, alpha = .4) +
  stat_summary(data = PastSAVEnvGrow.BASIN %>% 
                 group_by(year, waterbody) %>% 
                 summarize(Area.seg = sum(Area.seg, na.rm = T)) %>% 
                 ungroup(), # %>% 
                 #filter(cbpseg == "TANMH1"), #REACTIVE HERE
               aes(x = year, y = Area.seg), color = "black", 
               fun.data = mean_se, geom = "line", linewidth = 2.5) +
  labs(y = "SAV area (HA)", x = "") +
  theme_bw(base_size=16) + 
  scale_x_continuous(breaks=seq(1980, 2070, 10)) +
  scale_color_manual(values = scencol) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "right") + 
  facet_wrap(~waterbody, scales = "free_y")

BasinAreaRandoSim.Fig

```


#FullBaeFuture DFs: Combine everything and calculate simulation area totals
```{r FullBae Future DFs }
FullBaeFuture.Area_AllSims = FullBaeFuture.ALLDATA100 %>% 
  group_by(simnum_OB, year, Scen) %>%
  summarize(Area = sum(Area, na.rm = T), dens.weight.mean = sum(dens.weight.mean, na.rm = T)) %>% ungroup()

CommunityFuture.Area_AllSims = FullBaeFuture.ALLDATA100 %>% 
  group_by(simnum_OB, year, Scen, SpCluster) %>%
  summarize(Area = sum(Area, na.rm = T), dens.weight.mean = sum(dens.weight.mean, na.rm = T)) %>% ungroup()

#Some DFs to find max/.min/mean of all simnums
FullBaeFuture.Area_ByComm = CommunityFuture.Area_AllSims %>%
  group_by(year, Scen, SpCluster) %>% 
  summarize(Area.tot = mean(Area, na.rm = T), Area.max = max(Area, na.rm = T), Area.min = min(Area, na.rm = T),
            DWM.tot = mean(dens.weight.mean, na.rm = T), DWM.max = max(dens.weight.mean, na.rm = T), DWM.min = min(dens.weight.mean, na.rm = T)) %>% ungroup()

FullBaeFuture.Area_ByScen = FullBaeSAV.EnvGrow_2160 %>%
  group_by(year, Scen) %>% 
  summarize(Area.tot = mean(Area.seg, na.rm = T), Area.max = max(Area.seg, na.rm = T), Area.min = min(Area.seg, na.rm = T),
            DWM.tot = mean(DWM.seg, na.rm = T), DWM.max = max(DWM.seg, na.rm = T), DWM.min = min(DWM.seg, na.rm = T)) %>% ungroup()

FullBaeFuture.Area_ByBasin = FullBaeFuture.BASIN %>% 
  group_by(year, Scen, BASIN) %>% 
  summarize(Area.tot = mean(Area.tot, na.rm = T), Area.max = max(Area.tot, na.rm = T), Area.min = min(Area.tot, na.rm = T),
            DWM.tot = mean(DWM.tot, na.rm = T), DWM.max = max(DWM.tot, na.rm = T), DWM.min = min(DWM.tot, na.rm = T)) %>% ungroup()

FullBaeFuture.Area_BySeg = FullBaeFuture.SEGMENT %>% 
  group_by(year, Scen, SEG) %>% 
  summarize(Area.tot = mean(Area.tot, na.rm = T), Area.max = max(Area.tot, na.rm = T), Area.min = min(Area.tot, na.rm = T),
            DWM.tot = mean(DWM.tot, na.rm = T), DWM.max = max(DWM.tot, na.rm = T), DWM.min = min(DWM.tot, na.rm = T)) %>% ungroup()
```

#FINAL FIGURE BUILDING
#Scenario effect on Total Area

```{r FullBay_Area.byScen}

#d = FullBaeFuture.Area_AllSims %>% group_by(Scen, year) %>% slice_sample(., n = 20, replace = F)
FutureBaeArea_ByScen.fig =
ggplot(data = FullBaeSAV.EnvGrow_2160 %>% drop_na() %>% 
              group_by(simnum_OB, Scen, year) %>% summarise(Area.seg = sum(Area.seg, na.rm = T))) + 
    stat_summary(data = FullBaeSAV.EnvGrow_8420, 
               aes(x = year, y = Area.seg), 
               fun = "sum", geom = "line",  
               size = 4) +
  #geom_line(aes(x = year, y = Area.seg, group = simnum_OB), size = .4, alpha = .3) + 
  stat_summary(aes(x = year, y = Area.seg), 
               fun.data = "mean_se", geom = "line",  
               size = 3) +
  geom_ribbon(aes(color = Scen, fill = Scen, x = year, 
                  ymin = Area.seg - (sd(Area.seg)), ymax = Area.seg + (sd(Area.seg))),  alpha = .7) +
 # geom_labelsmooth(data = FullBaeFuture.Area_AllSims, aes(x = year, y = Area, color = Scen, label = Scen),
  #                 method = "lm", boxlinewidth = 0, size = 3, alpha = .7) +

  geom_smooth(aes(x = year, y = Area.seg), method = "gam", se = TRUE) +
  geom_text(aes(x = 2020, y = 72000, label = "Baywide SAV Goal (74,000 HA)"), stat = "unique", size = 8, color = "blue") +
  geom_hline(yintercept = 74000) +
  labs(y = "Total SAV area (HA)", x = "") +
  theme_bw(base_size=24) + 
  scale_x_continuous(breaks=seq(1980, 2070, 10)) +
  scale_color_manual(values = scencol) +
  theme(plot.margin = unit(c(1.3, 2, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "") +
  facet_wrap(~Scen)
FutureBaeArea_ByScen.fig


```




```{r}



```


#Figure: Community by Scenario predictions

```{r Community Area by Scen}
Community_Area.byScen.Fig =
ggplot(data = FullBaeFuture.Area_ByComm) + 
  stat_summary(data = SAVCommDensWQ_ForPred.with0s %>% filter(!SpCluster == "RuZo"), 
               aes(x = year, y = SAVArea, color = SpCluster), 
               fun = "sum", geom = "line",  
               size = 3) +
   # geom_line(data = CommunityFuture.Area_AllSims, aes(x = year, y = Area, group = simnum_OB, color = SpCluster), size = .4, alpha = .3) + 
  stat_summary(aes(x = year, y = Area.tot, color = SpCluster), 
               fun.data = mean_se, geom = "line",  
               size = 3) +
    geom_smooth(aes(x = year, y = Area.tot, group = SpCluster), method = "lm", se = TRUE) +  
  geom_labelsmooth(aes(x = year, y = Area.tot, label = SpCluster, color = SpCluster), 
                   method = "gam", boxlinewidth = 0, size = 5, alpha = .7) +
  labs(y = "Total SAV area (HA)", x = "") +
  theme_bw(base_size=24) + 
  scale_x_continuous(breaks=seq(1980, 2070, 10)) +
 scale_color_manual(values = commcol) +
  theme(plot.margin = unit(c(1.3, 2, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "") +
  facet_wrap(~Scen)

Community_Area.byScen.Fig

```


```{r FullBay_Area.byCommunity.Fig}
FullBay_Area.byCommunity.Fig =
ggplot(data = FullBaeFuture.Area_ByComm) + 
  stat_summary(data = SAVCommDensWQ_ForPred.with0s %>% filter(!SpCluster %in% c("RuZo")), 
               aes(x = year, y = SAVArea), 
               fun = "sum", geom = "line",  
               size = 3) +
 # geom_line(data = CommunityFuture.Area_AllSims, aes(x = year, y = Area, group = simnum_OB, color = Scen), size = .4, alpha = .3) + 
  stat_summary(aes(x = year, y = Area.tot, color = Scen), 
               fun.data = mean_se, geom = "line",  
               size = 3) +
    geom_smooth(aes(x = year, y = Area.tot, group = Scen), method = "gam", se = TRUE) +  
  geom_labelsmooth(aes(x = year, y = Area.tot, label = Scen, color = Scen), 
                   method = "lm", boxlinewidth = 0, size = 5, alpha = .7) +
  labs(y = "Total SAV area (HA)", x = "") +
  theme_bw(base_size=30) + 
  scale_x_continuous(breaks=seq(1980, 2070, 10)) +
  scale_color_manual(values = scencol) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "") +
  facet_wrap(~SpCluster, scales = "free_y")

FullBay_Area.byCommunity.Fig

```


#Figure: BASIN by Scenario predictions
```{r Basin_Area.byScen }
FullBaeFuture.BASIN
Basin_Area.byScen.Fig =
ggplot(data = FullBaeFuture.Area_ByBasin) + 
  stat_summary(data = SAVCommDensWQ_ForPred.BASIN, 
               aes(x = year, y = Area.tot), 
               fun = "sum", geom = "line",  
               size = 3) +
    geom_line(data = FullBaeFuture.BASIN %>% filter(Scen == "No Action"), aes(x = year, y = Area.tot, group = simnum_OB), size = .2, alpha = .2, color = "brown1") +
    geom_line(data = FullBaeFuture.BASIN %>% filter(Scen == "Nutrient Reduction"), aes(x = year, y = Area.tot, group = simnum_OB), size = .2, alpha = .2, color = "chartreuse4") +
  stat_summary(aes(x = year, y = Area.tot, color = Scen), 
               fun.data = mean_se, geom = "line",  
               size = 3) +
    geom_labelsmooth(aes(x = year, y = Area.tot, label = Scen, color = Scen), 
                   method = "lm", boxlinewidth = 0, size = 3.5, alpha = .65) +
  labs(y = "Total SAV area (HA)", x = "") +
  theme_bw(base_size=24) + 
  scale_x_continuous(breaks=seq(1980, 2070, 10)) +
  scale_color_manual(values = scencol) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "") +
  facet_wrap(~BASIN, scales = "free_y")

Basin_Area.byScen.Fig

```





#Extra Figs: 

```{r Past Community change over time}

Community_Area.Past.Fig =
ggplot(data = SAVCommDensWQ_ForPred.with0s)+ #%>% filter(SpCluster %in% c("Zostera", "Fresh", "Ruppia", "MixedMeso"))) + 
  stat_summary(aes(x = year, y = SAVArea, color = SpCluster), 
               fun = "sum", geom = "line",  
               size = 3) +
  labs(y = "Total SAV area (HA)", x = "") +
  theme_bw(base_size=30) + 
  scale_x_continuous(breaks=seq(1980, 2030, 10)) +
  scale_color_manual(values = c("darkgoldenrod2", "darkorchid", "blue4", "cyan3", "darkolivegreen4")) +
  theme(plot.margin = unit(c(1.3, 2, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "right")

Community_Area.Past.Fig

AllSAV = SAVCommDensWQ_ForPred.with0s %>%
  group_by(SpCluster, year) %>% 
  summarize(TotalSpCluster = sum(SAVArea, na.rm = T)) %>% 
  group_by(year) %>%
  mutate(TotalSAV = sum(TotalSpCluster, na.rm = T)) %>% ungroup() %>%
  group_by(SpCluster, year) %>%
  summarize(PropSpCluster = TotalSpCluster/TotalSAV)

Community_Prop.Past.Fig =
ggplot(data = AllSAV %>% filter(SpCluster %in% c("Zostera", "Fresh", "Ruppia", "MixedMeso"))) + 
  stat_summary(aes(x = year, y = PropSpCluster, color = SpCluster), 
               fun = "sum", geom = "line",  
               size = 3) +
  labs(y = expression(paste("Proportion of Bay \noccupied (%/year)")), x = "") +
  theme_bw(base_size=30) + 
  scale_x_continuous(breaks=seq(1980, 2030, 10)) +
  scale_color_manual(values = c("darkgoldenrod2", "darkorchid", "blue4", "darkolivegreen4" )) +
  theme(plot.margin = unit(c(1.3, 2, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")

Community_Prop.Past.Fig

AllEnv = SAVCommDensWQ_ForPred.with0s %>%
  group_by(year) %>%
  summarize(Temp = mean(Temp.sumy1med, na.rm = T), TN = mean(TN.spme, na.rm = T))

Temp.Past.Fig =
ggplot(data = AllEnv) + #%>% filter(SpCluster %in% c("Zostera", "Fresh", "Ruppia", "MixedMeso"))) + 
  stat_summary(aes(x = year, y = Temp), 
               fun = "mean", geom = "line",  
               size = 3) +
  labs(y = expression(paste("Temp mean")), x = "") +
  theme_bw(base_size=30) + 
  scale_x_continuous(breaks=seq(1980, 2030, 10)) +
 #scale_color_manual(values = c("darkgoldenrod2", "darkorchid", "blue4", "darkolivegreen4" )) +
  theme(plot.margin = unit(c(1.3, 2, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")

```


#Visualize Whole Bay MAX MIN MEAN by Scenario
```{r}
ggplot(data = FullBaeFuture.Area_ByScen) + 
  stat_summary(data = SAVCommDensWQ_ForPred.with0s, 
               aes(x = year, y = SAVArea, color = ), 
               fun = "sum", geom = "line",  
               size = 4) +
  #geom_ribbon(aes(x = year, ymin = Area.min, ymax = Area.max, fill = Scen), 
  #             alpha = .4) +
  stat_summary(aes(x = year, y = Area.max, color = Scen), 
               fun.data = mean_se, geom = "line",  
               size = 3) +
  stat_summary(aes(x = year, y = Area.min, color = Scen), 
               fun.data = mean_se, geom = "line",  
               size = 3) +
  geom_line(data = FullBaeFuture.Area_AllSims, aes(x = year, y = Area, group = simnum_OB), size = .4, alpha = .3) + 
    stat_summary(aes(x = year, y = Area.tot, color = Scen), 
               fun.data = mean_se, geom = "line",  
               size = 3) +
 # geom_labelsmooth(aes(x = year, y = Area.tot, label = Scen, color = Scen), 
 #                  method = "lm", boxlinewidth = 0, size = 5, alpha = .7) +
  geom_text(aes(x = 2020, y = 72000, label = "Baywide SAV Goal (74,000 HA)"), stat = "unique", size = 8, color = "blue") +
    geom_hline(yintercept = 74000) +
  labs(y = "Total SAV area (HA)", x = "") +
  theme_bw(base_size=30) + 
  scale_x_continuous(breaks=seq(1980, 2070, 10)) +
  scale_color_manual(values = c("darkgoldenrod1", "darkorchid")) +
  theme(plot.margin = unit(c(.3, 1, .3, 1.5), "cm"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "") +
  facet_wrap(~Scen)

```
